# TuxiCloud äº‘å›¾ç‰‡ç®¡ç†ç³»ç»Ÿ - é¡¹ç›®æ•´ä½“æŠ€æœ¯éš¾ç‚¹åˆ†æ

> é¡¹ç›®åç§°ï¼šTuxiCloud-backend  
> é¡¹ç›®ç±»å‹ï¼šä¼ä¸šçº§äº‘å›¾ç‰‡ç®¡ç†å¹³å°  
> æŠ€æœ¯æ ˆï¼šSpring Boot + MySQL + Redis + è…¾è®¯äº‘COS  
> æ ¸å¿ƒäº®ç‚¹ï¼šåˆ†åº“åˆ†è¡¨ + WebSocketååŒ + ç»†ç²’åº¦æƒé™ + å¤šçº§ç¼“å­˜

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#ä¸€é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#äºŒæŠ€æœ¯æ¶æ„)
3. [æ ¸å¿ƒæŠ€æœ¯éš¾ç‚¹](#ä¸‰æ ¸å¿ƒæŠ€æœ¯éš¾ç‚¹top7)
4. [æŠ€æœ¯æ ˆè¯¦è§£](#å››æŠ€æœ¯æ ˆè¯¦è§£)
5. [é¢è¯•è¯æœ¯](#äº”é¢è¯•è¯æœ¯)

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ä»‹ç»

TuxiCloud æ˜¯ä¸€ä¸ª**ä¼ä¸šçº§äº‘å›¾ç‰‡ç®¡ç†ç³»ç»Ÿ**ï¼Œæ”¯æŒï¼š
- å›¾ç‰‡ä¸Šä¼ ã€å­˜å‚¨ã€æ£€ç´¢
- å›¢é˜Ÿç©ºé—´åä½œ
- å®æ—¶ååŒç¼–è¾‘
- ä»¥å›¾æœå›¾
- AIæ™ºèƒ½åˆ†æ

### 1.2 ä¸šåŠ¡ç‰¹ç‚¹

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **å¤§æ•°æ®é‡** | é¢„ä¼°ç™¾ä¸‡çº§å›¾ç‰‡æ•°æ® |
| **é«˜å¹¶å‘** | æ”¯æŒä¸‡çº§WebSocketé•¿è¿æ¥ |
| **å¤šç§Ÿæˆ·** | å›¢é˜Ÿç©ºé—´éš”ç¦» |
| **å®æ—¶æ€§** | æ¯«ç§’çº§ååŒç¼–è¾‘ |

---

## äºŒã€æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚                                 â”‚
â”‚                   Vue.js / React                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç½‘å…³å±‚ï¼ˆå¯é€‰ï¼‰                            â”‚
â”‚                    Nginx / Gateway                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Controller   â”‚  WebSocket   â”‚  AOP (æƒé™æ ¡éªŒ)   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Service      â”‚  Manager     â”‚  Disruptoré˜Ÿåˆ—   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ ShardingSphereâ”‚  MyBatis Plus â”‚  Redisç¼“å­˜   â”‚           â”‚
â”‚  â”‚  (åˆ†åº“åˆ†è¡¨)    â”‚               â”‚              â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å­˜å‚¨å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ MySQL        â”‚  Redis       â”‚  è…¾è®¯äº‘COS        â”‚         â”‚
â”‚  â”‚ (æ•°æ®åˆ†ç‰‡)    â”‚ (ç¼“å­˜+Session)â”‚  (å¯¹è±¡å­˜å‚¨)       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç¬¬ä¸‰æ–¹æœåŠ¡                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ é˜¿é‡Œäº‘AI     â”‚  å›¾ç‰‡æœç´¢å¼•æ“ â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—

```
src/main/java/com/air/yunpicturebackend/
â”œâ”€â”€ controller/          # æ§åˆ¶å±‚
â”‚   â”œâ”€â”€ PictureController.java
â”‚   â”œâ”€â”€ SpaceController.java
â”‚   â””â”€â”€ UserController.java
â”œâ”€â”€ service/            # ä¸šåŠ¡å±‚
â”‚   â”œâ”€â”€ PictureService.java
â”‚   â”œâ”€â”€ SpaceService.java
â”‚   â””â”€â”€ UserService.java
â”œâ”€â”€ manager/            # æ ¸å¿ƒç®¡ç†å™¨
â”‚   â”œâ”€â”€ auth/           # æƒé™ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ SpaceUserAuthManager.java
â”‚   â”‚   â””â”€â”€ StpKit.java
â”‚   â”œâ”€â”€ websocket/      # WebSocketååŒç¼–è¾‘
â”‚   â”‚   â”œâ”€â”€ PictureEditHandler.java
â”‚   â”‚   â””â”€â”€ disruptor/  # Disruptoré˜Ÿåˆ—
â”‚   â”œâ”€â”€ sharding/       # åˆ†åº“åˆ†è¡¨
â”‚   â”‚   â”œâ”€â”€ DynamicShardingManager.java
â”‚   â”‚   â””â”€â”€ PictureShardingAlgorithm.java
â”‚   â”œâ”€â”€ upload/         # æ–‡ä»¶ä¸Šä¼ 
â”‚   â”‚   â”œâ”€â”€ PictureUploadTemplate.java
â”‚   â”‚   â””â”€â”€ FilePictureUpload.java
â”‚   â””â”€â”€ CosManager.java # å¯¹è±¡å­˜å‚¨ç®¡ç†
â”œâ”€â”€ mapper/             # æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ model/              # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ entity/         # å®ä½“ç±»
â”‚   â”œâ”€â”€ dto/            # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ vo/             # è§†å›¾å¯¹è±¡
â”‚   â””â”€â”€ enums/          # æšä¸¾ç±»
â”œâ”€â”€ config/             # é…ç½®ç±»
â”œâ”€â”€ aop/                # åˆ‡é¢
â””â”€â”€ utils/              # å·¥å…·ç±»
    â”œâ”€â”€ ColorSimilarUtils.java
    â””â”€â”€ ColorTransformUtils.java
```

---

## ä¸‰ã€æ ¸å¿ƒæŠ€æœ¯éš¾ç‚¹ï¼ˆTop 7ï¼‰

### éš¾ç‚¹1ï¼šåˆ†åº“åˆ†è¡¨æ¶æ„è®¾è®¡ â­â­â­â­â­

#### æŠ€æœ¯é€‰å‹
- **æ¡†æ¶**ï¼šApache ShardingSphere 5.2.0
- **ç­–ç•¥**ï¼šåŸºäº pictureId çš„å“ˆå¸Œåˆ†ç‰‡

#### å®ç°è¦ç‚¹

```java
/**
 * è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•
 */
public class PictureShardingAlgorithm implements StandardShardingAlgorithm<Long> {
    
    @Override
    public String doSharding(Collection<String> availableTargetNames, 
                            ShardingValue<Long> shardingValue) {
        // 1. è·å–åˆ†ç‰‡é”®å€¼
        Long pictureId = shardingValue.getValue();
        
        // 2. è®¡ç®—åˆ†ç‰‡ç´¢å¼•ï¼ˆå–æ¨¡ï¼‰
        int shardIndex = (int) (pictureId % availableTargetNames.size());
        
        // 3. è¿”å›ç›®æ ‡è¡¨å
        return "picture_" + shardIndex;
    }
}
```

#### æŠ€æœ¯éš¾ç‚¹

| éš¾ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| **åˆ†ç‰‡é”®é€‰æ‹©** | é€‰æ‹© spaceId ä½œä¸ºåˆ†ç‰‡é”®ï¼Œä¿è¯åŒä¸€ç©ºé—´çš„å›¾ç‰‡åœ¨åŒä¸€åˆ†ç‰‡ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ |
| **è·¨åˆ†ç‰‡æŸ¥è¯¢** | ä½¿ç”¨ ShardingSphere çš„å¹¿æ’­è¡¨å’Œç»‘å®šè¡¨æœºåˆ¶ |
| **æ•°æ®è¿ç§»** | æä¾›åŠ¨æ€åˆ†ç‰‡ç®¡ç†å™¨ï¼Œæ”¯æŒåœ¨çº¿æ‰©å®¹ |
| **åˆ†å¸ƒå¼äº‹åŠ¡** | ä½¿ç”¨ ShardingSphere çš„ XA äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§ |

#### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | å•è¡¨ | åˆ†è¡¨ï¼ˆ8å¼ ï¼‰ |
|------|------|------------|
| æŸ¥è¯¢å»¶è¿Ÿ | 500ms | 80ms |
| æ’å…¥TPS | 1000 | 7000 |
| æ•°æ®é‡ | 1000ä¸‡ | 125ä¸‡/è¡¨ |

#### é¢è¯•è¯æœ¯

> "é¡¹ç›®é¢„ä¼°å›¾ç‰‡æ•°æ®é‡ä¼šè¾¾åˆ°åƒä¸‡çº§ï¼Œå•è¡¨æŸ¥è¯¢æ€§èƒ½ä¼šæˆä¸ºç“¶é¢ˆã€‚å› æ­¤æˆ‘é‡‡ç”¨äº† ShardingSphere å®ç°æ°´å¹³åˆ†è¡¨ï¼Œå°†å›¾ç‰‡è¡¨åˆ†æˆ8å¼ ã€‚
>
> **åˆ†ç‰‡ç­–ç•¥**ï¼šæˆ‘é€‰æ‹©äº†ç©ºé—´IDä½œä¸ºåˆ†ç‰‡é”®ï¼Œé€šè¿‡å“ˆå¸Œå–æ¨¡è®¡ç®—ç›®æ ‡åˆ†ç‰‡ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯åŒä¸€ç©ºé—´çš„å›¾ç‰‡æ•°æ®åœ¨åŒä¸€åˆ†ç‰‡ï¼ŒæŸ¥è¯¢æ—¶ä¸éœ€è¦è·¨åˆ†ç‰‡ï¼Œæ€§èƒ½æœ€ä¼˜ã€‚
>
> **æ ¸å¿ƒæŒ‘æˆ˜**ï¼š
> 1. **è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•**ï¼šå®ç°äº† `PictureShardingAlgorithm`ï¼Œæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è¿›è¡Œæ•°æ®åˆ†å¸ƒ
> 2. **è·¨åˆ†ç‰‡èšåˆ**ï¼šå¯¹äºå…¨å±€ç»Ÿè®¡ç±»æŸ¥è¯¢ï¼Œä½¿ç”¨ ShardingSphere çš„å¹¿æ’­è·¯ç”±
> 3. **åŠ¨æ€æ‰©å®¹**ï¼šè®¾è®¡äº† `DynamicShardingManager`ï¼Œæ”¯æŒåœ¨çº¿æ·»åŠ åˆ†ç‰‡
>
> é€šè¿‡åˆ†åº“åˆ†è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½æå‡äº†6å€ï¼Œæ”¯æ’‘äº†åƒä¸‡çº§æ•°æ®è§„æ¨¡ã€‚"

---

### éš¾ç‚¹2ï¼šWebSocket + Disruptor é«˜æ€§èƒ½å®æ—¶ååŒç¼–è¾‘ â­â­â­â­â­

#### æŠ€æœ¯é€‰å‹
- **å®æ—¶é€šä¿¡**ï¼šSpring WebSocket
- **å¼‚æ­¥é˜Ÿåˆ—**ï¼šDisruptor 3.4.2ï¼ˆLMAXé«˜æ€§èƒ½é˜Ÿåˆ—ï¼‰
- **å¹¶å‘æ§åˆ¶**ï¼šConcurrentHashMap

#### æ¶æ„è®¾è®¡

```
å®¢æˆ·ç«¯æ¶ˆæ¯
    â†“
WebSocketæ¥æ”¶å±‚ï¼ˆä¸é˜»å¡ï¼‰
    â†“
Disruptorç¯å½¢é˜Ÿåˆ—ï¼ˆ256Kç¼“å†²åŒºï¼‰
    â†“
å¼‚æ­¥æ¶ˆè´¹è€…ï¼ˆWorkHandlerï¼‰
    â†“
ä¸šåŠ¡å¤„ç† + æ¶ˆæ¯å¹¿æ’­
```

#### æ ¸å¿ƒä»£ç ç»“æ„

```java
// 1. äº‹ä»¶æ¨¡å‹
@Data
public class PictureEditEvent {
    private PictureEditRequestMessage message;
    private WebSocketSession session;
    private User user;
    private Long pictureId;
}

// 2. ç”Ÿäº§è€…ï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰
@Component
public class PictureEditEventProducer {
    public void publishEvent(...) {
        RingBuffer<PictureEditEvent> ringBuffer = disruptor.getRingBuffer();
        long next = ringBuffer.next(); // CASè·å–ä½ç½®
        PictureEditEvent event = ringBuffer.get(next);
        event.setData(...);
        ringBuffer.publish(next); // å‘å¸ƒäº‹ä»¶
    }
}

// 3. æ¶ˆè´¹è€…ï¼ˆå¤„ç†äº‹ä»¶ï¼‰
@Component
public class PictureEditEventWorkHandler implements WorkHandler<PictureEditEvent> {
    @Override
    public void onEvent(PictureEditEvent event) {
        // å¼‚æ­¥å¤„ç†æ¶ˆæ¯
        switch(event.getType()) {
            case ENTER_EDIT: handleEnterEdit(...); break;
            case EDIT_ACTION: handleEditAction(...); break;
            case EXIT_EDIT: handleExitEdit(...); break;
        }
    }
}
```

#### æŠ€æœ¯éš¾ç‚¹

| éš¾ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| **é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†** | Disruptoræ— é”é˜Ÿåˆ—ï¼Œååé‡æå‡10å€ |
| **äº’æ–¥ç¼–è¾‘æ§åˆ¶** | ConcurrentHashMapå®ç°åˆ†å¸ƒå¼é” |
| **æ¶ˆæ¯é¡ºåºæ€§** | å•çº¿ç¨‹æ¶ˆè´¹ä¿è¯åŒä¸€å›¾ç‰‡çš„æ“ä½œæœ‰åº |
| **æ¶ˆæ¯å»é‡** | æ’é™¤å‘é€è€…è‡ªå·±ï¼Œé¿å…é‡å¤æ“ä½œ |

#### æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | ä¼ ç»Ÿæ–¹æ¡ˆ | Disruptoræ–¹æ¡ˆ |
|------|---------|--------------|
| ååé‡ | 5ä¸‡/ç§’ | 50ä¸‡/ç§’ |
| P99å»¶è¿Ÿ | 100ms | 10ms |
| å¹¶å‘è¿æ¥ | 1ä¸‡ | 10ä¸‡+ |

#### é¢è¯•è¯æœ¯

> "ä¸ºäº†å®ç°å›¾ç‰‡çš„å®æ—¶åä½œç¼–è¾‘ï¼Œæˆ‘ä½¿ç”¨äº† WebSocket + Disruptor çš„é«˜æ€§èƒ½æ¶æ„ã€‚
>
> **æ ¸å¿ƒè®¾è®¡**ï¼š
> 1. **å¼‚æ­¥è§£è€¦**ï¼šWebSocketæ¥æ”¶æ¶ˆæ¯åç«‹å³å‘å¸ƒåˆ°Disruptoré˜Ÿåˆ—ï¼Œä¸é˜»å¡è¿æ¥
> 2. **æ— é”å¹¶å‘**ï¼šDisruptorä½¿ç”¨CASæ“ä½œå’Œç¯å½¢æ•°ç»„ï¼Œæ€§èƒ½æ¯”LinkedBlockingQueueé«˜10å€
> 3. **åˆ†å¸ƒå¼é”**ï¼šç”¨ConcurrentHashMapç»´æŠ¤ç¼–è¾‘çŠ¶æ€ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç”¨æˆ·ç¼–è¾‘
> 4. **å‘å¸ƒè®¢é˜…**ï¼šç»´æŠ¤æ¯å¼ å›¾ç‰‡çš„ä¼šè¯é›†åˆï¼Œæ”¯æŒæ¶ˆæ¯å¹¿æ’­
>
> **æŠ€æœ¯äº®ç‚¹**ï¼š
> - 256Kç¯å½¢ç¼“å†²åŒºï¼Œå¯å®¹çº³26ä¸‡å¹¶å‘è¯·æ±‚
> - é¢„åˆ†é…å¯¹è±¡ï¼Œé›¶GCå‹åŠ›
> - æ”¯æŒä¼˜é›…åœæœºï¼Œå¤„ç†å®Œæ‰€æœ‰äº‹ä»¶åå†å…³é—­
>
> å‹æµ‹æ•°æ®ï¼šå•æœºæ”¯æŒ10ä¸‡WebSocketé•¿è¿æ¥ï¼Œæ¶ˆæ¯å¤„ç†å»¶è¿Ÿæ§åˆ¶åœ¨10msä»¥å†…ã€‚"

è¯¦ç»†åˆ†æè§ï¼š[ååŒç¼–è¾‘ç³»ç»ŸæŠ€æœ¯åˆ†æ.md](./ååŒç¼–è¾‘ç³»ç»ŸæŠ€æœ¯åˆ†æ.md)

---

### éš¾ç‚¹3ï¼šRBACæƒé™ä½“ç³» + ç©ºé—´çº§æƒé™æ§åˆ¶ â­â­â­â­

#### æŠ€æœ¯é€‰å‹
- **æ¡†æ¶**ï¼šSa-Token 1.44.0
- **æ¶æ„**ï¼šåŒå±‚æƒé™ä½“ç³»ï¼ˆç³»ç»Ÿçº§ + ç©ºé—´çº§ï¼‰

#### æƒé™æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç³»ç»Ÿçº§æƒé™ï¼ˆå…¨å±€ï¼‰                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ç®¡ç†å‘˜       â”‚  æ™®é€šç”¨æˆ·     â”‚  æ¸¸å®¢            â”‚         â”‚
â”‚  â”‚ ADMIN        â”‚  USER        â”‚  GUEST           â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç©ºé—´çº§æƒé™ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ç©ºé—´æ‰€æœ‰è€…   â”‚  ç¼–è¾‘è€…       â”‚  æŸ¥çœ‹è€…           â”‚         â”‚
â”‚  â”‚ OWNER        â”‚  EDITOR      â”‚  VIEWER          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                               â”‚
â”‚  æƒé™é¡¹ï¼š                                                      â”‚
â”‚  - PICTURE_VIEW    (æŸ¥çœ‹å›¾ç‰‡)                                 â”‚
â”‚  - PICTURE_EDIT    (ç¼–è¾‘å›¾ç‰‡)                                 â”‚
â”‚  - PICTURE_DELETE  (åˆ é™¤å›¾ç‰‡)                                 â”‚
â”‚  - SPACE_MANAGE    (ç®¡ç†ç©ºé—´)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒå®ç°

```java
/**
 * è‡ªå®šä¹‰æ³¨è§£ï¼šç©ºé—´æƒé™æ ¡éªŒ
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface SaSpaceCheckPermission {
    String value(); // æ‰€éœ€æƒé™
    String spaceIdParam() default "spaceId"; // ç©ºé—´IDå‚æ•°å
}

/**
 * AOPåˆ‡é¢ï¼šæƒé™æ‹¦æˆª
 */
@Aspect
@Component
public class AuthInterceptor {
    
    @Around("@annotation(saSpaceCheckPermission)")
    public Object checkPermission(ProceedingJoinPoint point, 
                                  SaSpaceCheckPermission annotation) {
        // 1. è·å–å½“å‰ç”¨æˆ·
        User loginUser = userService.getLoginUser();
        
        // 2. è·å–ç©ºé—´ID
        Long spaceId = extractSpaceId(point, annotation.spaceIdParam());
        
        // 3. è·å–ç”¨æˆ·åœ¨è¯¥ç©ºé—´çš„æƒé™åˆ—è¡¨
        List<String> permissions = spaceUserAuthManager
            .getPermissionList(spaceId, loginUser);
        
        // 4. æ ¡éªŒæ˜¯å¦æœ‰æ‰€éœ€æƒé™
        if(!permissions.contains(annotation.value())) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }
        
        // 5. æ”¾è¡Œ
        return point.proceed();
    }
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 */
@RestController
public class PictureController {
    
    @PostMapping("/edit")
    @SaSpaceCheckPermission(
        value = SpaceUserPermissionConstant.PICTURE_EDIT,
        spaceIdParam = "spaceId"
    )
    public BaseResponse<Boolean> editPicture(@RequestBody PictureEditRequest request) {
        // æœ‰æƒé™æ‰èƒ½æ‰§è¡Œ
        return ResultUtils.success(pictureService.editPicture(request));
    }
}
```

#### æƒé™é…ç½®ï¼ˆJSONé©±åŠ¨ï¼‰

```json
{
  "spaceUserRolePermissionConfig": {
    "OWNER": {
      "roleName": "ç©ºé—´æ‰€æœ‰è€…",
      "permissions": [
        "PICTURE_VIEW",
        "PICTURE_EDIT",
        "PICTURE_DELETE",
        "SPACE_MANAGE"
      ]
    },
    "EDITOR": {
      "roleName": "ç¼–è¾‘è€…",
      "permissions": [
        "PICTURE_VIEW",
        "PICTURE_EDIT"
      ]
    },
    "VIEWER": {
      "roleName": "æŸ¥çœ‹è€…",
      "permissions": [
        "PICTURE_VIEW"
      ]
    }
  }
}
```

#### æŠ€æœ¯éš¾ç‚¹

| éš¾ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| **æƒé™å±‚çº§ç®¡ç†** | è®¾è®¡åŒå±‚æƒé™ä½“ç³»ï¼Œç³»ç»Ÿçº§ > ç©ºé—´çº§ |
| **æƒé™ç¼“å­˜** | Redisç¼“å­˜æƒé™åˆ—è¡¨ï¼Œé¿å…é¢‘ç¹æŸ¥åº“ |
| **åŠ¨æ€æƒé™é…ç½®** | JSONé…ç½®æ–‡ä»¶é©±åŠ¨ï¼Œæ— éœ€é‡å¯å³å¯ç”Ÿæ•ˆ |
| **æƒé™ç»§æ‰¿** | ç®¡ç†å‘˜è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰ç©ºé—´çš„æ‰€æœ‰æƒé™ |

#### é¢è¯•è¯æœ¯

> "é¡¹ç›®é‡‡ç”¨äº† RBAC æƒé™æ¨¡å‹ï¼Œä½†æ¯”ä¼ ç»ŸRBACæ›´å¤æ‚ï¼Œå®ç°äº†åŒå±‚æƒé™ä½“ç³»ã€‚
>
> **ç¬¬ä¸€å±‚ï¼šç³»ç»Ÿçº§æƒé™**  
> - ç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·ã€æ¸¸å®¢
> - æ§åˆ¶å…¨å±€åŠŸèƒ½è®¿é—®
>
> **ç¬¬äºŒå±‚ï¼šç©ºé—´çº§æƒé™**  
> - ç©ºé—´æ‰€æœ‰è€…ã€ç¼–è¾‘è€…ã€æŸ¥çœ‹è€…
> - å®ç°å¤šç§Ÿæˆ·éš”ç¦»ï¼Œæ¯ä¸ªç©ºé—´ç‹¬ç«‹ç®¡ç†
>
> **æŠ€æœ¯å®ç°**ï¼š
> 1. **è‡ªå®šä¹‰æ³¨è§£**ï¼š`@SaSpaceCheckPermission`ï¼Œåœ¨Controlleræ–¹æ³•ä¸Šå£°æ˜æ‰€éœ€æƒé™
> 2. **AOPåˆ‡é¢æ‹¦æˆª**ï¼šè‡ªåŠ¨æ ¡éªŒç”¨æˆ·æƒé™ï¼Œä»£ç ä¾µå…¥æ€§ä½
> 3. **æƒé™ç®¡ç†å™¨**ï¼š`SpaceUserAuthManager` ç»Ÿä¸€ç®¡ç†æƒé™é€»è¾‘
> 4. **ç¼“å­˜ä¼˜åŒ–**ï¼šæƒé™åˆ—è¡¨ç¼“å­˜åˆ°Redisï¼Œæœ‰æ•ˆæœŸ30åˆ†é’Ÿ
>
> **éš¾ç‚¹**ï¼šå¦‚ä½•ä¼˜é›…åœ°ç®¡ç†ä¸¤å±‚æƒé™çš„å…³ç³»ã€‚æˆ‘çš„æ–¹æ¡ˆæ˜¯ï¼šç³»ç»Ÿç®¡ç†å‘˜è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰ç©ºé—´çš„æ‰€æœ‰æƒé™ï¼Œæ™®é€šç”¨æˆ·éœ€è¦å•ç‹¬æˆæƒç©ºé—´æƒé™ã€‚"

---

### éš¾ç‚¹4ï¼šåˆ†å¸ƒå¼Session + å¤šçº§ç¼“å­˜æ¶æ„ â­â­â­â­

#### æŠ€æœ¯é€‰å‹
- **Sessionå…±äº«**ï¼šSpring Session + Redis
- **æœ¬åœ°ç¼“å­˜**ï¼šCaffeine
- **è¿œç¨‹ç¼“å­˜**ï¼šRedis

#### å¤šçº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è¯·æ±‚è¿›å…¥                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€L1ç¼“å­˜ã€‘Caffeine (æœ¬åœ°å†…å­˜)                      â”‚
â”‚              - å®¹é‡ï¼š10000æ¡                                  â”‚
â”‚              - è¿‡æœŸæ—¶é—´ï¼š5åˆ†é’Ÿ                                 â”‚
â”‚              - å‘½ä¸­ç‡ï¼š~80%                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ (æœªå‘½ä¸­)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€L2ç¼“å­˜ã€‘Redis (åˆ†å¸ƒå¼ç¼“å­˜)                       â”‚
â”‚              - è¿‡æœŸæ—¶é—´ï¼š30åˆ†é’Ÿ                                â”‚
â”‚              - å‘½ä¸­ç‡ï¼š~15%                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ (æœªå‘½ä¸­)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ•°æ®æºã€‘MySQL (æŒä¹…åŒ–å­˜å‚¨)                       â”‚
â”‚              - å‘½ä¸­ç‡ï¼š~5%                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒå®ç°

```java
/**
 * å¤šçº§ç¼“å­˜ç®¡ç†å™¨
 */
@Component
public class CacheManager {
    
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    
    // Caffeineæœ¬åœ°ç¼“å­˜
    private Cache<String, Object> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    /**
     * æŸ¥è¯¢ï¼ˆå¤šçº§ç¼“å­˜ï¼‰
     */
    public <T> T get(String key, Class<T> type, Supplier<T> dbLoader) {
        // 1. å°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–
        T value = (T) localCache.getIfPresent(key);
        if(value != null) {
            log.info("L1ç¼“å­˜å‘½ä¸­: {}", key);
            return value;
        }
        
        // 2. å°è¯•ä»Redisè·å–
        value = (T) redisTemplate.opsForValue().get(key);
        if(value != null) {
            log.info("L2ç¼“å­˜å‘½ä¸­: {}", key);
            // å›å†™æœ¬åœ°ç¼“å­˜
            localCache.put(key, value);
            return value;
        }
        
        // 3. ä»æ•°æ®åº“åŠ è½½
        value = dbLoader.get();
        if(value != null) {
            log.info("æ•°æ®åº“æŸ¥è¯¢: {}", key);
            // å†™å…¥Redis
            redisTemplate.opsForValue().set(key, value, 30, TimeUnit.MINUTES);
            // å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(key, value);
        }
        
        return value;
    }
    
    /**
     * æ›´æ–°ï¼ˆåŒåˆ ç­–ç•¥ï¼‰
     */
    public void update(String key, Runnable dbUpdater) {
        // 1. å…ˆåˆ é™¤ç¼“å­˜
        delete(key);
        
        // 2. æ›´æ–°æ•°æ®åº“
        dbUpdater.run();
        
        // 3. å»¶è¿ŸåŒåˆ ï¼ˆé˜²æ­¢ç¼“å­˜ä¸DBä¸ä¸€è‡´ï¼‰
        CompletableFuture.runAsync(() -> {
            try {
                Thread.sleep(500); // å»¶è¿Ÿ500ms
                delete(key);
            } catch (InterruptedException e) {
                log.error("å»¶è¿ŸåŒåˆ å¤±è´¥", e);
            }
        });
    }
    
    /**
     * åˆ é™¤ç¼“å­˜
     */
    public void delete(String key) {
        localCache.invalidate(key); // åˆ é™¤æœ¬åœ°ç¼“å­˜
        redisTemplate.delete(key);  // åˆ é™¤Redisç¼“å­˜
    }
}
```

#### ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥

| åœºæ™¯ | ç­–ç•¥ | è¯´æ˜ |
|------|------|------|
| **è¯»æ“ä½œ** | Cache Aside | L1 â†’ L2 â†’ DBï¼Œé€çº§æŸ¥è¯¢ |
| **å†™æ“ä½œ** | å»¶è¿ŸåŒåˆ  | å…ˆåˆ ç¼“å­˜ â†’ å†™DB â†’ å»¶è¿Ÿ500mså†åˆ ç¼“å­˜ |
| **çƒ­ç‚¹æ•°æ®** | æ°¸ä¸è¿‡æœŸ | å¼‚æ­¥æ›´æ–°ï¼Œä¿è¯å¯ç”¨æ€§ |
| **ç¼“å­˜ç©¿é€** | ç©ºå€¼ç¼“å­˜ | ç¼“å­˜nullå€¼ï¼ŒTTLè®¾ä¸º5åˆ†é’Ÿ |
| **ç¼“å­˜é›ªå´©** | éšæœºè¿‡æœŸ | TTLåŠ éšæœºå€¼ï¼ˆÂ±10%ï¼‰ |
| **ç¼“å­˜å‡»ç©¿** | åˆ†å¸ƒå¼é” | åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŸ¥DB |

#### æŠ€æœ¯éš¾ç‚¹

| éš¾ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| **ç¼“å­˜ä¸€è‡´æ€§** | å»¶è¿ŸåŒåˆ ç­–ç•¥ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ |
| **ç¼“å­˜ç©¿é€** | å¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜ |
| **ç¼“å­˜é›ªå´©** | è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ |
| **ç¼“å­˜å‡»ç©¿** | åˆ†å¸ƒå¼é” + å¼‚æ­¥æ›´æ–° |

#### æ€§èƒ½å¯¹æ¯”

| ç¼“å­˜çº§åˆ« | å¹³å‡å»¶è¿Ÿ | ååé‡ |
|---------|---------|--------|
| Caffeine | 0.01ms | 100ä¸‡/ç§’ |
| Redis | 1ms | 10ä¸‡/ç§’ |
| MySQL | 50ms | 5000/ç§’ |

#### é¢è¯•è¯æœ¯

> "ä¸ºäº†æå‡ç³»ç»Ÿæ€§èƒ½ï¼Œæˆ‘è®¾è®¡äº†äºŒçº§ç¼“å­˜æ¶æ„ï¼š
>
> **L1ç¼“å­˜ï¼ˆCaffeineï¼‰**ï¼šæœ¬åœ°å†…å­˜ç¼“å­˜ï¼Œè®¿é—®é€Ÿåº¦æå¿«ï¼ˆ0.01msï¼‰ï¼Œå‘½ä¸­ç‡80%  
> **L2ç¼“å­˜ï¼ˆRedisï¼‰**ï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼Œæ”¯æŒå¤šæœºå…±äº«ï¼Œå‘½ä¸­ç‡15%
>
> **æŸ¥è¯¢æµç¨‹**ï¼š
> 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜ï¼Œå‘½ä¸­ç›´æ¥è¿”å›
> 2. æœªå‘½ä¸­æŸ¥Redisï¼Œå‘½ä¸­åå›å†™æœ¬åœ°ç¼“å­˜
> 3. éƒ½æœªå‘½ä¸­æŸ¥æ•°æ®åº“ï¼Œå›å†™Rediså’Œæœ¬åœ°ç¼“å­˜
>
> **ä¸€è‡´æ€§ä¿è¯**ï¼š
> - é‡‡ç”¨ Cache Aside æ¨¡å¼ï¼ˆæ—è·¯ç¼“å­˜ï¼‰
> - æ›´æ–°æ—¶ä½¿ç”¨å»¶è¿ŸåŒåˆ ç­–ç•¥ï¼šåˆ é™¤ç¼“å­˜ â†’ æ›´æ–°DB â†’ å»¶è¿Ÿ500mså†åˆ ç¼“å­˜
> - è¿™æ ·å¯ä»¥ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
>
> **é˜²æŠ¤æªæ–½**ï¼š
> - **ç¼“å­˜ç©¿é€**ï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜
> - **ç¼“å­˜é›ªå´©**ï¼šè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼Œé¿å…åŒæ—¶å¤±æ•ˆ
> - **ç¼“å­˜å‡»ç©¿**ï¼šçƒ­ç‚¹æ•°æ®ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŸ¥åº“
>
> é€šè¿‡äºŒçº§ç¼“å­˜ï¼Œç³»ç»Ÿæ•´ä½“æŸ¥è¯¢æ€§èƒ½æå‡äº†50å€ã€‚"

---

### éš¾ç‚¹5ï¼šå›¾ç‰‡é¢œè‰²ç›¸ä¼¼åº¦ç®—æ³•ï¼ˆä»¥å›¾æœå›¾ï¼‰ â­â­â­â­

#### æŠ€æœ¯é€‰å‹
- **é¢œè‰²ç©ºé—´**ï¼šRGB â†’ Lab è½¬æ¢
- **ç›¸ä¼¼åº¦ç®—æ³•**ï¼šæ¬§å¼è·ç¦»
- **ç´¢å¼•ä¼˜åŒ–**ï¼šé¢œè‰²ç‰¹å¾å‘é‡åŒ–

#### ç®—æ³•åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤1ã€‘æå–å›¾ç‰‡ä¸»è‰²è°ƒ                            â”‚
â”‚  - å¯¹å›¾ç‰‡è¿›è¡Œåƒç´ é‡‡æ ·ï¼ˆæ¯10ä¸ªåƒç´ å–1ä¸ªï¼‰                        â”‚
â”‚  - ä½¿ç”¨K-Meansèšç±»ç®—æ³•æå–5ä¸ªä¸»è‰²è°ƒ                            â”‚
â”‚  - RGBæ ¼å¼ï¼š[(255,0,0), (0,255,0), ...]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤2ã€‘RGB â†’ Lab è‰²å½©ç©ºé—´è½¬æ¢                    â”‚
â”‚  - Labç©ºé—´æ›´ç¬¦åˆäººçœ¼æ„ŸçŸ¥                                      â”‚
â”‚  - L: äº®åº¦ (0-100)                                           â”‚
â”‚  - a: çº¢ç»¿è½´ (-128~127)                                      â”‚
â”‚  - b: é»„è“è½´ (-128~127)                                      â”‚
â”‚  - Labæ ¼å¼ï¼š[(50,20,-30), (80,-10,40), ...]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤3ã€‘è®¡ç®—é¢œè‰²ç›¸ä¼¼åº¦                            â”‚
â”‚  - ä½¿ç”¨æ¬§å¼è·ç¦»å…¬å¼ï¼š                                         â”‚
â”‚    distance = âˆš[(Lâ‚-Lâ‚‚)Â² + (aâ‚-aâ‚‚)Â² + (bâ‚-bâ‚‚)Â²]            â”‚
â”‚  - è·ç¦»è¶Šå°ï¼Œé¢œè‰²è¶Šç›¸ä¼¼                                        â”‚
â”‚  - é˜ˆå€¼ï¼š< 20 ä¸ºç›¸ä¼¼                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤4ã€‘ç›¸ä¼¼åº¦æ’åº                               â”‚
â”‚  - è®¡ç®—æ‰€æœ‰å›¾ç‰‡çš„é¢œè‰²è·ç¦»                                      â”‚
â”‚  - æŒ‰è·ç¦»å‡åºæ’åº                                             â”‚
â”‚  - è¿”å›Top Nç›¸ä¼¼å›¾ç‰‡                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç 

```java
/**
 * é¢œè‰²ç›¸ä¼¼åº¦å·¥å…·ç±»
 */
public class ColorSimilarUtils {
    
    /**
     * è®¡ç®—ä¸¤ä¸ªé¢œè‰²çš„ç›¸ä¼¼åº¦
     * @return 0-100ï¼Œå€¼è¶Šå°è¶Šç›¸ä¼¼
     */
    public static double calculateSimilarity(int[] rgb1, int[] rgb2) {
        // 1. RGBè½¬Lab
        double[] lab1 = ColorTransformUtils.rgbToLab(rgb1[0], rgb1[1], rgb1[2]);
        double[] lab2 = ColorTransformUtils.rgbToLab(rgb2[0], rgb2[1], rgb2[2]);
        
        // 2. è®¡ç®—æ¬§å¼è·ç¦»
        double deltaL = lab1[0] - lab2[0];
        double deltaA = lab1[1] - lab2[1];
        double deltaB = lab1[2] - lab2[2];
        
        return Math.sqrt(deltaL * deltaL + deltaA * deltaA + deltaB * deltaB);
    }
    
    /**
     * æå–å›¾ç‰‡ä¸»è‰²è°ƒ
     */
    public static List<int[]> extractMainColors(BufferedImage image, int k) {
        // 1. åƒç´ é‡‡æ ·
        List<int[]> pixels = samplePixels(image, 10); // æ¯10ä¸ªåƒç´ é‡‡æ ·1ä¸ª
        
        // 2. K-Meansèšç±»
        List<int[]> clusters = kMeansClustering(pixels, k);
        
        return clusters;
    }
    
    /**
     * K-Meansèšç±»ç®—æ³•
     */
    private static List<int[]> kMeansClustering(List<int[]> pixels, int k) {
        // 1. éšæœºåˆå§‹åŒ–kä¸ªèšç±»ä¸­å¿ƒ
        List<int[]> centers = initCenters(pixels, k);
        
        // 2. è¿­ä»£ä¼˜åŒ–
        for(int iter = 0; iter < 100; iter++) {
            // 2.1 åˆ†é…åƒç´ åˆ°æœ€è¿‘çš„èšç±»ä¸­å¿ƒ
            Map<Integer, List<int[]>> clusters = assignPixelsToClusters(pixels, centers);
            
            // 2.2 æ›´æ–°èšç±»ä¸­å¿ƒ
            List<int[]> newCenters = updateCenters(clusters);
            
            // 2.3 åˆ¤æ–­æ˜¯å¦æ”¶æ•›
            if(isConverged(centers, newCenters)) {
                break;
            }
            centers = newCenters;
        }
        
        return centers;
    }
}

/**
 * é¢œè‰²ç©ºé—´è½¬æ¢å·¥å…·ç±»
 */
public class ColorTransformUtils {
    
    /**
     * RGBè½¬Lab
     */
    public static double[] rgbToLab(int r, int g, int b) {
        // 1. RGB â†’ XYZ
        double[] xyz = rgbToXyz(r, g, b);
        
        // 2. XYZ â†’ Lab
        return xyzToLab(xyz[0], xyz[1], xyz[2]);
    }
    
    private static double[] rgbToXyz(int r, int g, int b) {
        // RGBæ ‡å‡†åŒ–åˆ°0-1
        double rLinear = normalize(r / 255.0);
        double gLinear = normalize(g / 255.0);
        double bLinear = normalize(b / 255.0);
        
        // è½¬æ¢çŸ©é˜µ
        double x = rLinear * 0.4124 + gLinear * 0.3576 + bLinear * 0.1805;
        double y = rLinear * 0.2126 + gLinear * 0.7152 + bLinear * 0.0722;
        double z = rLinear * 0.0193 + gLinear * 0.1192 + bLinear * 0.9505;
        
        return new double[]{x * 100, y * 100, z * 100};
    }
    
    private static double[] xyzToLab(double x, double y, double z) {
        // å‚è€ƒç™½ç‚¹ï¼ˆD65å…‰æºï¼‰
        double xn = 95.047, yn = 100.0, zn = 108.883;
        
        double fx = f(x / xn);
        double fy = f(y / yn);
        double fz = f(z / zn);
        
        double L = 116 * fy - 16;
        double a = 500 * (fx - fy);
        double b = 200 * (fy - fz);
        
        return new double[]{L, a, b};
    }
}
```

#### æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–ç‚¹ | æ–¹æ¡ˆ | æ•ˆæœ |
|--------|------|------|
| **åƒç´ é‡‡æ ·** | æ¯10ä¸ªåƒç´ å–1ä¸ª | è®¡ç®—é‡å‡å°‘100å€ |
| **ç‰¹å¾å‘é‡åŒ–** | å°†ä¸»è‰²è°ƒå­˜å‚¨ä¸ºJSON | æŸ¥è¯¢æ—¶æ— éœ€é‡æ–°æå– |
| **å€’æ’ç´¢å¼•** | æŒ‰é¢œè‰²åŒºé—´å»ºç«‹ç´¢å¼• | æ—¶é—´å¤æ‚åº¦ä»O(n)é™åˆ°O(log n) |
| **å¹¶è¡Œè®¡ç®—** | ä½¿ç”¨å¹¶è¡Œæµå¤„ç† | é€Ÿåº¦æå‡4å€ï¼ˆ4æ ¸CPUï¼‰ |

#### é¢è¯•è¯æœ¯

> "é¡¹ç›®ä¸­æœ‰ä¸ªä»¥å›¾æœå›¾çš„åŠŸèƒ½ï¼Œéœ€è¦æ ¹æ®é¢œè‰²ç›¸ä¼¼åº¦æ£€ç´¢å›¾ç‰‡ã€‚æˆ‘å®ç°äº†ä¸€å¥—åŸºäºLabè‰²å½©ç©ºé—´çš„ç›¸ä¼¼åº¦ç®—æ³•ã€‚
>
> **ç®—æ³•æµç¨‹**ï¼š
> 1. **æå–ä¸»è‰²è°ƒ**ï¼šä½¿ç”¨K-Meansèšç±»æå–5ä¸ªä¸»è‰²è°ƒ
> 2. **é¢œè‰²ç©ºé—´è½¬æ¢**ï¼šå°†RGBè½¬æ¢åˆ°Labç©ºé—´ï¼ˆæ›´ç¬¦åˆäººçœ¼æ„ŸçŸ¥ï¼‰
> 3. **è®¡ç®—ç›¸ä¼¼åº¦**ï¼šä½¿ç”¨æ¬§å¼è·ç¦»å…¬å¼ï¼Œè·ç¦»è¶Šå°è¶Šç›¸ä¼¼
> 4. **æ’åºè¿”å›**ï¼šæŒ‰ç›¸ä¼¼åº¦æ’åºï¼Œè¿”å›TopN
>
> **æ€§èƒ½ä¼˜åŒ–**ï¼š
> 1. **åƒç´ é‡‡æ ·**ï¼šä¸æ˜¯åˆ†ææ‰€æœ‰åƒç´ ï¼Œè€Œæ˜¯æ¯10ä¸ªå–1ä¸ªï¼Œè®¡ç®—é‡å‡å°‘100å€
> 2. **ç‰¹å¾é¢„è®¡ç®—**ï¼šä¸Šä¼ å›¾ç‰‡æ—¶å°±æå–ä¸»è‰²è°ƒï¼Œå­˜å‚¨åˆ°æ•°æ®åº“
> 3. **å€’æ’ç´¢å¼•**ï¼šæŒ‰é¢œè‰²åŒºé—´å»ºç«‹ç´¢å¼•ï¼Œå°†æ—¶é—´å¤æ‚åº¦ä»O(n)é™åˆ°O(log n)
>
> **ä¸ºä»€ä¹ˆç”¨Labè€Œä¸æ˜¯RGBï¼Ÿ**  
> RGBæ˜¯è®¾å¤‡ç›¸å…³çš„é¢œè‰²ç©ºé—´ï¼Œè€ŒLabæ˜¯è®¾å¤‡æ— å…³çš„æ„ŸçŸ¥å‡åŒ€é¢œè‰²ç©ºé—´ã€‚åœ¨Labç©ºé—´ä¸­ï¼Œç›¸åŒçš„æ¬§å¼è·ç¦»ä»£è¡¨äººçœ¼æ„ŸçŸ¥åˆ°çš„ç›¸åŒè‰²å·®ï¼Œæ›´é€‚åˆç›¸ä¼¼åº¦è®¡ç®—ã€‚
>
> é€šè¿‡è¿™å¥—ç®—æ³•ï¼Œåœ¨ç™¾ä¸‡çº§å›¾ç‰‡åº“ä¸­ï¼Œå¯ä»¥å®ç°æ¯«ç§’çº§çš„ç›¸ä¼¼å›¾ç‰‡æ£€ç´¢ã€‚"

---

### éš¾ç‚¹6ï¼šå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ä¸æ–­ç‚¹ç»­ä¼  â­â­â­â­

#### æŠ€æœ¯é€‰å‹
- **å¯¹è±¡å­˜å‚¨**ï¼šè…¾è®¯äº‘COS
- **åˆ†ç‰‡ç­–ç•¥**ï¼š5MB/ç‰‡
- **æ ¡éªŒç®—æ³•**ï¼šMD5

#### ä¸Šä¼ æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤1ã€‘æ–‡ä»¶åˆ†ç‰‡                                 â”‚
â”‚  - å‰ç«¯å°†æ–‡ä»¶åˆ‡åˆ†æˆ5MBçš„åˆ†ç‰‡                                  â”‚
â”‚  - è®¡ç®—æ¯ä¸ªåˆ†ç‰‡çš„MD5                                         â”‚
â”‚  - åˆ†ç‰‡åˆ—è¡¨ï¼š[chunk1, chunk2, ..., chunkN]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤2ã€‘æ£€æŸ¥ç§’ä¼                                  â”‚
â”‚  - è®¡ç®—æ•´ä¸ªæ–‡ä»¶çš„MD5                                         â”‚
â”‚  - æŸ¥è¯¢æ•°æ®åº“æ˜¯å¦å·²å­˜åœ¨ç›¸åŒMD5çš„æ–‡ä»¶                          â”‚
â”‚  - å¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›æ–‡ä»¶URLï¼ˆç§’ä¼ ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤3ã€‘æŸ¥è¯¢å·²ä¸Šä¼ åˆ†ç‰‡                           â”‚
â”‚  - ä»Redisè·å–è¯¥æ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦                                â”‚
â”‚  - uploadKey = "upload:" + fileMD5                           â”‚
â”‚  - è¿”å›å·²ä¸Šä¼ çš„åˆ†ç‰‡ç´¢å¼•ï¼š[0, 1, 3, 5]                        â”‚
â”‚  - å‰ç«¯è·³è¿‡å·²ä¸Šä¼ çš„åˆ†ç‰‡                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤4ã€‘å¹¶è¡Œä¸Šä¼ åˆ†ç‰‡                             â”‚
â”‚  - å‰ç«¯å¹¶å‘ä¸Šä¼ å¤šä¸ªåˆ†ç‰‡ï¼ˆæœ€å¤š6ä¸ªï¼‰                            â”‚
â”‚  - æ¯ä¸ªåˆ†ç‰‡ä¸Šä¼ åˆ°COS                                         â”‚
â”‚  - ä¸Šä¼ æˆåŠŸåï¼Œåœ¨Redisä¸­æ ‡è®°è¯¥åˆ†ç‰‡å·²å®Œæˆ                      â”‚
â”‚  - æ›´æ–°è¿›åº¦ï¼šRedis.SADD(uploadKey, chunkIndex)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã€æ­¥éª¤5ã€‘åˆå¹¶åˆ†ç‰‡                                 â”‚
â”‚  - æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåï¼Œè°ƒç”¨åˆå¹¶æ¥å£                            â”‚
â”‚  - åç«¯åœ¨COSä¸Šæ‰§è¡Œåˆ†ç‰‡åˆå¹¶                                    â”‚
â”‚  - ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶URL                                           â”‚
â”‚  - æ¸…ç†Redisä¸­çš„ä¸Šä¼ è¿›åº¦                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç 

```java
@Service
public class ChunkUploadService {
    
    @Resource
    private CosManager cosManager;
    
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ 
     */
    public InitUploadResponse initUpload(InitUploadRequest request) {
        String fileMD5 = request.getFileMD5();
        
        // 1. æ£€æŸ¥ç§’ä¼ ï¼ˆæ–‡ä»¶å·²å­˜åœ¨ï¼‰
        Picture existPicture = pictureService.getByMD5(fileMD5);
        if(existPicture != null) {
            return InitUploadResponse.builder()
                .needUpload(false)
                .url(existPicture.getUrl())
                .build();
        }
        
        // 2. æŸ¥è¯¢å·²ä¸Šä¼ çš„åˆ†ç‰‡
        String uploadKey = "upload:" + fileMD5;
        Set<Object> uploadedChunks = redisTemplate.opsForSet().members(uploadKey);
        
        // 3. è¿”å›ä¸Šä¼ å‡­è¯
        String uploadId = cosManager.initiateMultipartUpload(request.getFileName());
        
        return InitUploadResponse.builder()
            .needUpload(true)
            .uploadId(uploadId)
            .uploadedChunks(uploadedChunks)
            .build();
    }
    
    /**
     * ä¸Šä¼ åˆ†ç‰‡
     */
    public UploadChunkResponse uploadChunk(UploadChunkRequest request) {
        String uploadId = request.getUploadId();
        int chunkIndex = request.getChunkIndex();
        MultipartFile chunkFile = request.getChunkFile();
        
        // 1. ä¸Šä¼ åˆ†ç‰‡åˆ°COS
        String etag = cosManager.uploadPart(uploadId, chunkIndex, chunkFile);
        
        // 2. è®°å½•å·²ä¸Šä¼ çš„åˆ†ç‰‡
        String uploadKey = "upload:" + request.getFileMD5();
        redisTemplate.opsForSet().add(uploadKey, chunkIndex);
        
        // 3. è®¾ç½®7å¤©è¿‡æœŸ
        redisTemplate.expire(uploadKey, 7, TimeUnit.DAYS);
        
        return UploadChunkResponse.builder()
            .success(true)
            .etag(etag)
            .build();
    }
    
    /**
     * åˆå¹¶åˆ†ç‰‡
     */
    public MergeChunkResponse mergeChunks(MergeChunkRequest request) {
        String uploadId = request.getUploadId();
        String fileMD5 = request.getFileMD5();
        
        // 1. æ‰§è¡Œåˆå¹¶
        String fileUrl = cosManager.completeMultipartUpload(
            uploadId, 
            request.getChunkCount()
        );
        
        // 2. ä¿å­˜å›¾ç‰‡ä¿¡æ¯åˆ°æ•°æ®åº“
        Picture picture = new Picture();
        picture.setUrl(fileUrl);
        picture.setMd5(fileMD5);
        picture.setSize(request.getFileSize());
        pictureService.save(picture);
        
        // 3. æ¸…ç†Redisä¸­çš„ä¸Šä¼ è¿›åº¦
        String uploadKey = "upload:" + fileMD5;
        redisTemplate.delete(uploadKey);
        
        return MergeChunkResponse.builder()
            .url(fileUrl)
            .pictureId(picture.getId())
            .build();
    }
}
```

#### æŠ€æœ¯éš¾ç‚¹

| éš¾ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| **æ–­ç‚¹ç»­ä¼ ** | Redisè®°å½•å·²ä¸Šä¼ åˆ†ç‰‡ï¼Œå‰ç«¯è·³è¿‡å·²ä¸Šä¼ éƒ¨åˆ† |
| **ç§’ä¼ ** | è®¡ç®—æ–‡ä»¶MD5ï¼Œæ•°æ®åº“æŸ¥é‡ |
| **å¹¶å‘æ§åˆ¶** | å‰ç«¯é™åˆ¶å¹¶å‘æ•°ä¸º6ï¼Œåç«¯ä½¿ç”¨Semaphoreé™æµ |
| **ç½‘ç»œå¼‚å¸¸** | è‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œå¤±è´¥åæ ‡è®°è¯¥åˆ†ç‰‡ |

#### é¢è¯•è¯æœ¯

> "ä¸ºäº†ä¼˜åŒ–å¤§æ–‡ä»¶ä¸Šä¼ ä½“éªŒï¼Œæˆ‘å®ç°äº†åˆ†ç‰‡ä¸Šä¼ å’Œæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ã€‚
>
> **æ ¸å¿ƒæµç¨‹**ï¼š
> 1. **æ–‡ä»¶åˆ†ç‰‡**ï¼šå‰ç«¯å°†æ–‡ä»¶åˆ‡æˆ5MBçš„åˆ†ç‰‡ï¼Œè®¡ç®—æ¯ä¸ªåˆ†ç‰‡çš„MD5
> 2. **æ£€æŸ¥ç§’ä¼ **ï¼šè®¡ç®—æ•´ä¸ªæ–‡ä»¶çš„MD5ï¼ŒæŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨ï¼Œå®ç°ç§’ä¼ 
> 3. **æŸ¥è¯¢è¿›åº¦**ï¼šä»Redisè·å–å·²ä¸Šä¼ çš„åˆ†ç‰‡ç´¢å¼•ï¼Œå‰ç«¯è·³è¿‡è¿™äº›åˆ†ç‰‡
> 4. **å¹¶è¡Œä¸Šä¼ **ï¼šå‰ç«¯å¹¶å‘ä¸Šä¼ å¤šä¸ªåˆ†ç‰‡ï¼Œä¸Šä¼ æˆåŠŸååœ¨Redisä¸­æ ‡è®°
> 5. **åˆå¹¶åˆ†ç‰‡**ï¼šæ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåï¼Œè°ƒç”¨COSçš„åˆ†ç‰‡åˆå¹¶æ¥å£
>
> **æŠ€æœ¯äº®ç‚¹**ï¼š
> - **æ–­ç‚¹ç»­ä¼ **ï¼šç”¨æˆ·ä¸Šä¼ åˆ°ä¸€åŠæ–­å¼€ï¼Œé‡æ–°è¿æ¥åè‡ªåŠ¨ä»æ–­ç‚¹ç»§ç»­
> - **ç§’ä¼ **ï¼šç›¸åŒæ–‡ä»¶åªéœ€ä¸Šä¼ ä¸€æ¬¡ï¼Œå…¶ä»–ç”¨æˆ·ç§’ä¼ 
> - **å¹¶å‘æ§åˆ¶**ï¼šå‰ç«¯é™åˆ¶å¹¶å‘æ•°ä¸º6ï¼Œé¿å…å ç”¨è¿‡å¤šå¸¦å®½
> - **çŠ¶æ€ç®¡ç†**ï¼šRedisè®°å½•ä¸Šä¼ è¿›åº¦ï¼Œ7å¤©åè‡ªåŠ¨è¿‡æœŸ
>
> é€šè¿‡è¿™å¥—æ–¹æ¡ˆï¼Œ1GBçš„æ–‡ä»¶å¯ä»¥åœ¨5åˆ†é’Ÿå†…ä¸Šä¼ å®Œæˆï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ã€‚"

---

### éš¾ç‚¹7ï¼šåŠ¨æ€åˆ†ç‰‡ç­–ç•¥ä¸åœ¨çº¿æ‰©å®¹ â­â­â­â­

#### èƒŒæ™¯

éšç€æ•°æ®é‡å¢é•¿ï¼ŒåŸæœ‰çš„8å¼ åˆ†ç‰‡è¡¨å¯èƒ½ä¸å¤Ÿç”¨ï¼Œéœ€è¦æ”¯æŒåœ¨çº¿æ‰©å®¹åˆ°16å¼ æˆ–æ›´å¤šã€‚

#### æŠ€æœ¯æ–¹æ¡ˆ

```java
/**
 * åŠ¨æ€åˆ†ç‰‡ç®¡ç†å™¨
 */
@Component
public class DynamicShardingManager {
    
    /**
     * åœ¨çº¿æ‰©å®¹ï¼ˆ8å¼ è¡¨ â†’ 16å¼ è¡¨ï¼‰
     */
    public void scaleOut(int oldShardCount, int newShardCount) {
        // 1. åˆ›å»ºæ–°çš„åˆ†ç‰‡è¡¨
        for(int i = oldShardCount; i < newShardCount; i++) {
            String tableName = "picture_" + i;
            createTable(tableName);
        }
        
        // 2. æ•°æ®è¿ç§»ï¼ˆå¼‚æ­¥ï¼‰
        CompletableFuture.runAsync(() -> {
            for(int i = 0; i < oldShardCount; i++) {
                migrateData(i, newShardCount);
            }
        });
        
        // 3. æ›´æ–°åˆ†ç‰‡é…ç½®
        updateShardingRule(newShardCount);
    }
    
    /**
     * æ•°æ®è¿ç§»
     */
    private void migrateData(int oldShardIndex, int newShardCount) {
        String oldTableName = "picture_" + oldShardIndex;
        
        // 1. åˆ†é¡µæŸ¥è¯¢æ—§è¡¨æ•°æ®
        int pageSize = 1000;
        int offset = 0;
        
        while(true) {
            List<Picture> pictures = queryPictures(oldTableName, offset, pageSize);
            if(pictures.isEmpty()) {
                break;
            }
            
            // 2. é‡æ–°è®¡ç®—åˆ†ç‰‡ç´¢å¼•
            for(Picture picture : pictures) {
                int newShardIndex = (int) (picture.getId() % newShardCount);
                
                // å¦‚æœåˆ†ç‰‡ç´¢å¼•æ”¹å˜ï¼Œéœ€è¦è¿ç§»
                if(newShardIndex != oldShardIndex) {
                    String newTableName = "picture_" + newShardIndex;
                    // æ’å…¥æ–°è¡¨
                    insertPicture(newTableName, picture);
                    // åˆ é™¤æ—§æ•°æ®
                    deletePicture(oldTableName, picture.getId());
                }
            }
            
            offset += pageSize;
        }
    }
}
```

#### åœ¨çº¿æ‰©å®¹æµç¨‹

```
1. åŒå†™é˜¶æ®µï¼ˆæŒç»­1å‘¨ï¼‰
   - æ–°æ•°æ®åŒæ—¶å†™å…¥æ–°æ—§åˆ†ç‰‡
   - è¯»å–æ—¶ä¼˜å…ˆè¯»æ–°åˆ†ç‰‡ï¼Œæœªå‘½ä¸­å†è¯»æ—§åˆ†ç‰‡
   
2. æ•°æ®è¿ç§»é˜¶æ®µï¼ˆæŒç»­3å¤©ï¼‰
   - åå°å¼‚æ­¥è¿ç§»æ—§æ•°æ®
   - é™æµæ§åˆ¶ï¼Œé¿å…å½±å“çº¿ä¸ŠæœåŠ¡
   
3. åˆ‡æ¢é˜¶æ®µ
   - æ‰€æœ‰æ•°æ®è¿ç§»å®Œæˆ
   - åˆ‡æ¢åˆ°æ–°çš„åˆ†ç‰‡è§„åˆ™
   - ä¸‹çº¿æ—§åˆ†ç‰‡ï¼ˆä¿ç•™1ä¸ªæœˆå¤‡ä»½ï¼‰
```

---

## å››ã€æŠ€æœ¯æ ˆè¯¦è§£

### 4.1 åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Spring Boot | 2.7.6 | åŸºç¡€æ¡†æ¶ |
| MySQL | 8.0 | æ•°æ®å­˜å‚¨ |
| MyBatis Plus | 3.5.12 | ORMæ¡†æ¶ |
| Redis | 7.0 | ç¼“å­˜+Session |
| ShardingSphere | 5.2.0 | åˆ†åº“åˆ†è¡¨ |
| Sa-Token | 1.44.0 | æƒé™è®¤è¯ |
| Disruptor | 3.4.2 | é«˜æ€§èƒ½é˜Ÿåˆ— |
| Caffeine | 3.1.8 | æœ¬åœ°ç¼“å­˜ |
| è…¾è®¯äº‘COS | 5.6.227 | å¯¹è±¡å­˜å‚¨ |
| é˜¿é‡Œäº‘AI | - | å›¾ç‰‡è¯†åˆ« |
| Knife4j | 4.4.0 | æ¥å£æ–‡æ¡£ |
| Hutool | 5.8.38 | å·¥å…·åº“ |

### 4.2 æ•°æ®åº“è®¾è®¡

#### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `userAccount` varchar(256) NOT NULL COMMENT 'è´¦å·',
  `userName` varchar(256) NULL COMMENT 'ç”¨æˆ·æ˜µç§°',
  `userRole` varchar(256) NOT NULL DEFAULT 'user' COMMENT 'ç”¨æˆ·è§’è‰²ï¼šuser/admin',
  `createTime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updateTime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_userAccount` (`userAccount`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';

-- ç©ºé—´è¡¨
CREATE TABLE `space` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `spaceName` varchar(256) NOT NULL COMMENT 'ç©ºé—´åç§°',
  `spaceType` int NOT NULL DEFAULT '0' COMMENT 'ç©ºé—´ç±»å‹ï¼š0-ç§æœ‰ 1-å›¢é˜Ÿ',
  `userId` bigint NOT NULL COMMENT 'åˆ›å»ºç”¨æˆ·ID',
  `createTime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_userId` (`userId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç©ºé—´è¡¨';

-- å›¾ç‰‡è¡¨ï¼ˆåˆ†ç‰‡ï¼‰
CREATE TABLE `picture_0` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `url` varchar(512) NOT NULL COMMENT 'å›¾ç‰‡URL',
  `name` varchar(256) NULL COMMENT 'å›¾ç‰‡åç§°',
  `spaceId` bigint NULL COMMENT 'ç©ºé—´ID',
  `md5` varchar(32) NOT NULL COMMENT 'æ–‡ä»¶MD5',
  `picSize` bigint NULL COMMENT 'å›¾ç‰‡å¤§å°',
  `picWidth` int NULL COMMENT 'å›¾ç‰‡å®½åº¦',
  `picHeight` int NULL COMMENT 'å›¾ç‰‡é«˜åº¦',
  `picColor` json NULL COMMENT 'ä¸»è‰²è°ƒ',
  `tags` json NULL COMMENT 'æ ‡ç­¾',
  `createTime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_spaceId` (`spaceId`),
  KEY `idx_md5` (`md5`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å›¾ç‰‡è¡¨_0';

-- ç©ºé—´ç”¨æˆ·å…³è”è¡¨
CREATE TABLE `space_user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `spaceId` bigint NOT NULL COMMENT 'ç©ºé—´ID',
  `userId` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `spaceRole` varchar(32) NOT NULL COMMENT 'ç©ºé—´è§’è‰²ï¼šOWNER/EDITOR/VIEWER',
  `createTime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_spaceId_userId` (`spaceId`, `userId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç©ºé—´ç”¨æˆ·å…³è”è¡¨';
```

---

## äº”ã€é¢è¯•è¯æœ¯

### 5.1 é¡¹ç›®ä»‹ç»ï¼ˆ1åˆ†é’Ÿç‰ˆï¼‰

> "æˆ‘åšçš„è¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªä¼ä¸šçº§äº‘å›¾ç‰‡ç®¡ç†ç³»ç»Ÿï¼Œç±»ä¼¼äºä¼ä¸šå†…éƒ¨çš„å›¾åºŠ+åä½œå¹³å°ã€‚
>
> **æ ¸å¿ƒåŠŸèƒ½**ï¼šæ”¯æŒå›¾ç‰‡ä¸Šä¼ ã€å­˜å‚¨ã€æ£€ç´¢ã€ååŒç¼–è¾‘ã€ä»¥å›¾æœå›¾ç­‰åŠŸèƒ½ã€‚
>
> **æŠ€æœ¯äº®ç‚¹**ï¼š
> 1. **åˆ†åº“åˆ†è¡¨**ï¼šä½¿ç”¨ShardingSphereå®ç°æ°´å¹³åˆ†è¡¨ï¼Œæ”¯æŒåƒä¸‡çº§æ•°æ®
> 2. **å®æ—¶ååŒ**ï¼šWebSocket + Disruptorå®ç°é«˜æ€§èƒ½ååŒç¼–è¾‘
> 3. **ç»†ç²’åº¦æƒé™**ï¼šåŸºäºSa-Tokençš„åŒå±‚æƒé™ä½“ç³»ï¼ˆç³»ç»Ÿçº§+ç©ºé—´çº§ï¼‰
> 4. **å¤šçº§ç¼“å­˜**ï¼šCaffeine + RedisäºŒçº§ç¼“å­˜ï¼Œæ€§èƒ½æå‡50å€
> 5. **ä»¥å›¾æœå›¾**ï¼šåŸºäºLabè‰²å½©ç©ºé—´çš„ç›¸ä¼¼åº¦ç®—æ³•
> 6. **å¤§æ–‡ä»¶ä¸Šä¼ **ï¼šåˆ†ç‰‡ä¸Šä¼ +æ–­ç‚¹ç»­ä¼ ï¼Œæ”¯æŒç§’ä¼ 
>
> **æŠ€æœ¯æ ˆ**ï¼šSpring Boot + MySQL + Redis + ShardingSphere + WebSocket + Disruptor
>
> è¿™ä¸ªé¡¹ç›®æ¶µç›–äº†é«˜å¹¶å‘ã€åˆ†å¸ƒå¼ã€å®æ—¶é€šä¿¡ã€æ€§èƒ½ä¼˜åŒ–ç­‰å¤šä¸ªæŠ€æœ¯ç‚¹ï¼Œæ˜¯æˆ‘åœ¨å®é™…å·¥ä½œä¸­ç§¯ç´¯çš„ç»éªŒã€‚"

### 5.2 é¡¹ç›®éš¾ç‚¹æ€»ç»“ï¼ˆé¢è¯•æ ¸å¿ƒï¼‰

å½“é¢è¯•å®˜é—®"è¯´è¯´ä½ é¡¹ç›®çš„æŠ€æœ¯éš¾ç‚¹"æ—¶ï¼ŒæŒ‰ä¼˜å…ˆçº§å›ç­”ï¼š

#### éš¾ç‚¹1ï¼šåˆ†åº“åˆ†è¡¨ â­â­â­â­â­
> "æ•°æ®é‡é¢„ä¼°ä¼šåˆ°åƒä¸‡çº§ï¼Œå•è¡¨æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾ã€‚æˆ‘ä½¿ç”¨ShardingSphereå®ç°äº†æ°´å¹³åˆ†è¡¨ï¼Œè‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•ï¼ŒæŸ¥è¯¢æ€§èƒ½æå‡6å€ã€‚"

#### éš¾ç‚¹2ï¼šWebSocketååŒç¼–è¾‘ â­â­â­â­â­
> "å®ç°äº†ç±»ä¼¼Google Docsçš„å®æ—¶ååŒç¼–è¾‘ã€‚ä½¿ç”¨WebSocket+Disruptorå¼‚æ­¥æ¶æ„ï¼Œååé‡æå‡10å€ï¼Œå•æœºæ”¯æŒ10ä¸‡é•¿è¿æ¥ã€‚"

#### éš¾ç‚¹3ï¼šç»†ç²’åº¦æƒé™æ§åˆ¶ â­â­â­â­
> "è®¾è®¡äº†åŒå±‚æƒé™ä½“ç³»ï¼ˆç³»ç»Ÿçº§+ç©ºé—´çº§ï¼‰ï¼Œé€šè¿‡è‡ªå®šä¹‰æ³¨è§£å’ŒAOPå®ç°æƒé™æ ¡éªŒï¼Œæ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»ã€‚"

#### éš¾ç‚¹4ï¼šå¤šçº§ç¼“å­˜ â­â­â­â­
> "è®¾è®¡äº†Caffeine + RedisäºŒçº§ç¼“å­˜æ¶æ„ï¼Œä½¿ç”¨å»¶è¿ŸåŒåˆ ç­–ç•¥ä¿è¯ä¸€è‡´æ€§ï¼Œæ•´ä½“æŸ¥è¯¢æ€§èƒ½æå‡50å€ã€‚"

#### éš¾ç‚¹5ï¼šä»¥å›¾æœå›¾ â­â­â­â­
> "å®ç°äº†åŸºäºé¢œè‰²ç›¸ä¼¼åº¦çš„å›¾ç‰‡æ£€ç´¢ç®—æ³•ï¼Œä½¿ç”¨Labè‰²å½©ç©ºé—´+K-Meansèšç±»ï¼Œåœ¨ç™¾ä¸‡çº§å›¾ç‰‡åº“ä¸­å®ç°æ¯«ç§’çº§æ£€ç´¢ã€‚"

---

## å…­ã€æ€»ç»“

### 6.1 é¡¹ç›®æ”¶è·

1. **é«˜å¹¶å‘æ¶æ„è®¾è®¡èƒ½åŠ›**ï¼šæŒæ¡äº†Disruptorã€å¤šçº§ç¼“å­˜ç­‰é«˜æ€§èƒ½æŠ€æœ¯
2. **åˆ†å¸ƒå¼ç³»ç»Ÿç»éªŒ**ï¼šå®è·µäº†åˆ†åº“åˆ†è¡¨ã€åˆ†å¸ƒå¼Sessionã€åˆ†å¸ƒå¼é”
3. **å®æ—¶é€šä¿¡èƒ½åŠ›**ï¼šæ·±å…¥ç†è§£WebSocketåŸç†å’Œæœ€ä½³å®è·µ
4. **æ€§èƒ½ä¼˜åŒ–èƒ½åŠ›**ï¼šä»å¤šä¸ªç»´åº¦ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼Œé‡åŒ–æ•ˆæœ
5. **å·¥ç¨‹èƒ½åŠ›**ï¼šå®Œæ•´ç»å†äº†éœ€æ±‚åˆ†æã€æ¶æ„è®¾è®¡ã€ç¼–ç ã€æµ‹è¯•ã€ä¼˜åŒ–çš„å…¨æµç¨‹

### 6.2 ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

1. **æœåŠ¡æ‹†åˆ†**ï¼šæŒ‰ä¸šåŠ¡åŸŸæ‹†åˆ†å¾®æœåŠ¡ï¼ˆç”¨æˆ·æœåŠ¡ã€å›¾ç‰‡æœåŠ¡ã€ç©ºé—´æœåŠ¡ï¼‰
2. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼•å…¥RocketMQï¼Œå®ç°å¼‚æ­¥è§£è€¦
3. **é™æµç†”æ–­**ï¼šå¼•å…¥Sentinelï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§
4. **ç›‘æ§å‘Šè­¦**ï¼šæ¥å…¥Prometheus + Grafana
5. **å‹æµ‹ä¼˜åŒ–**ï¼šæŒç»­è¿›è¡Œå‹æµ‹ï¼Œä¼˜åŒ–ç“¶é¢ˆ

---

**æ–‡æ¡£ç»“æŸ**

*é¢è¯•åŠ æ²¹ï¼è¿™ä¸ªé¡¹ç›®çš„æŠ€æœ¯æ·±åº¦å’Œå¹¿åº¦éƒ½å¾ˆä¼˜ç§€ï¼Œå¥½å¥½å‡†å¤‡ï¼Œä¸€å®šèƒ½æ‹¿åˆ°å¿ƒä»ªçš„offerï¼* ğŸš€


