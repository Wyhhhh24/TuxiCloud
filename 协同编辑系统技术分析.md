# TuxiCloud ååŒç¼–è¾‘ç³»ç»Ÿ - å®Œæ•´æŠ€æœ¯åˆ†ææ–‡æ¡£

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#ä¸€ç³»ç»Ÿæ¶æ„è®¾è®¡)
2. [æ ¸å¿ƒæ•°æ®ç»“æ„](#äºŒæ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡)
3. [å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹](#ä¸‰å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹)
4. [Disruptoré«˜æ€§èƒ½å¼‚æ­¥å¤„ç†](#å››disruptor-é«˜æ€§èƒ½å¼‚æ­¥å¤„ç†)
5. [å¹¶å‘å®‰å…¨è®¾è®¡](#äº”å¹¶å‘å®‰å…¨è®¾è®¡)
6. [ç³»ç»Ÿäº®ç‚¹ä¸æŠ€æœ¯éš¾ç‚¹](#å…­ç³»ç»Ÿäº®ç‚¹ä¸æŠ€æœ¯éš¾ç‚¹æ€»ç»“)
7. [é¢è¯•è¯æœ¯](#ä¸ƒé¢è¯•è¯æœ¯å®Œæ•´ç‰ˆ)
8. [å¯èƒ½çš„è¿½é—®åŠå›ç­”](#å…«å¯èƒ½çš„è¿½é—®åŠå›ç­”)

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1 æ•´ä½“æ¶æ„

ååŒç¼–è¾‘ç³»ç»Ÿé‡‡ç”¨äº† **WebSocket + Disruptor å¼‚æ­¥è§£è€¦æ¶æ„**ï¼Œæ•´ä½“æ¶æ„åˆ†ä¸ºå››å±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å‰ç«¯å®¢æˆ·ç«¯å±‚                            â”‚
â”‚         WebSocket Client (å¤šä¸ªç”¨æˆ·åŒæ—¶è¿æ¥)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WebSocketè¿æ¥å±‚                            â”‚
â”‚  WsHandshakeInterceptor (æ¡æ‰‹æ‹¦æˆª)                            â”‚
â”‚  PictureEditHandler (æ¶ˆæ¯å¤„ç†)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Disruptorå¼‚æ­¥é˜Ÿåˆ—å±‚                        â”‚
â”‚  Producer (ç”Ÿäº§è€…) â†’ RingBuffer (ç¯å½¢é˜Ÿåˆ—) â†’ Consumer (æ¶ˆè´¹è€…)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡å¤„ç†å±‚                               â”‚
â”‚  handleEnterEdit / handleExitEdit / handleEditAction        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | ç±»å | èŒè´£ |
|------|------|------|
| **WebSocketé…ç½®** | `WebSocketConfig` | æ³¨å†ŒWebSocketç«¯ç‚¹å’Œæ‹¦æˆªå™¨ |
| **æ¡æ‰‹æ‹¦æˆªå™¨** | `WsHandshakeInterceptor` | è¿æ¥å‰çš„æƒé™æ ¡éªŒ |
| **æ¶ˆæ¯å¤„ç†å™¨** | `PictureEditHandler` | å¤„ç†WebSocketæ¶ˆæ¯ |
| **Disruptoré…ç½®** | `PictureEditEventDisruptorConfig` | é…ç½®ç¯å½¢é˜Ÿåˆ— |
| **äº‹ä»¶ç”Ÿäº§è€…** | `PictureEditEventProducer` | å‘å¸ƒäº‹ä»¶åˆ°é˜Ÿåˆ— |
| **äº‹ä»¶æ¶ˆè´¹è€…** | `PictureEditEventWorkHandler` | å¼‚æ­¥æ¶ˆè´¹äº‹ä»¶ |
| **äº‹ä»¶æ¨¡å‹** | `PictureEditEvent` | äº‹ä»¶æ•°æ®è½½ä½“ |

---

## äºŒã€æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡

### 2.1 ä¸¤ä¸ªå…³é”®çš„ ConcurrentHashMapï¼ˆâ˜…â˜…â˜…â˜…â˜…ï¼‰

```java
/**
 * ã€æ ¸å¿ƒ1ã€‘æ¯å¼ å›¾ç‰‡å¯¹åº”æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ï¼ˆä¿è¯äº’æ–¥ç¼–è¾‘ï¼‰
 * Key: pictureId
 * Value: æ­£åœ¨ç¼–è¾‘çš„userId
 * ä½œç”¨ï¼šå®ç°åˆ†å¸ƒå¼é”åŠŸèƒ½ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç”¨æˆ·èƒ½ç¼–è¾‘å›¾ç‰‡
 */
private final Map<Long, Long> pictureEditingUsers = new ConcurrentHashMap<>();

/**
 * ã€æ ¸å¿ƒ2ã€‘æ¯å¼ å›¾ç‰‡å¯¹åº”çš„æ‰€æœ‰WebSocketä¼šè¯ï¼ˆç”¨äºå¹¿æ’­ï¼‰
 * Key: pictureId
 * Value: WebSocketSessioné›†åˆ
 * ä½œç”¨ï¼šå®ç°å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œæ”¯æŒæ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰è§‚å¯Ÿè€…
 */
private final Map<Long, Set<WebSocketSession>> pictureSessions = new ConcurrentHashMap<>();
```

### 2.2 è®¾è®¡ç²¾é«“

- **`pictureEditingUsers`**ï¼šå®ç°åˆ†å¸ƒå¼é”åŠŸèƒ½ï¼Œä¿è¯äº’æ–¥ç¼–è¾‘ï¼ˆä¸€ä¸ª pictureId å¯¹åº”ä¸€ä¸ª userId ï¼Œç‹¬å é”ï¼Œä¿è¯ä¸€å¼ å›¾ç‰‡åªèƒ½ä¸€ä¸ªç”¨æˆ·åœ¨ç¼–è¾‘ï¼‰
- **`pictureSessions`**ï¼šå®ç°å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œæ”¯æŒæ¶ˆæ¯å¹¿æ’­ï¼ˆä¸€ä¸ª pictureId å¯¹åº”ä¸€ä¸ª userId é›†åˆï¼Œä¸€ä¸ªå›¾ç‰‡å¯ä»¥å¤šäººè¿›è¡Œç¼–è¾‘ï¼‰
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨ `ConcurrentHashMap` ä¿è¯å¤šçº¿ç¨‹å®‰å…¨ï¼Œé¿å…æ•°æ®ç«äº‰
- **ç»†ç²’åº¦é”**ï¼šä»¥å›¾ç‰‡IDä¸ºç»´åº¦åŠ é”ï¼Œä¸åŒå›¾ç‰‡çš„ç¼–è¾‘äº’ä¸å½±å“

### 2.3 æ¶ˆæ¯æ¨¡å‹

#### è¯·æ±‚æ¶ˆæ¯ï¼ˆå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼‰

```java
@Data
public class PictureEditRequestMessage {
    /**
     * æ¶ˆæ¯ç±»å‹ï¼š"ENTER_EDIT"ã€"EXIT_EDIT"ã€"EDIT_ACTION"
     */
    private String type;
    
    /**
     * ç¼–è¾‘åŠ¨ä½œï¼š"ZOOM_IN"ã€"ZOOM_OUT"ã€"ROTATE_LEFT"ã€"ROTATE_RIGHT"
     */
    private String editAction;
}
```

#### å“åº”æ¶ˆæ¯ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰

```java
@Data
public class PictureEditResponseMessage {
    /**
     * æ¶ˆæ¯ç±»å‹ï¼š"INFO"ã€"ERROR"ã€"ENTER_EDIT"ã€"EXIT_EDIT"ã€"EDIT_ACTION"
     */
    private String type;
    
    /**
     * æ¶ˆæ¯å†…å®¹ï¼šå¦‚"ç”¨æˆ·å¼ ä¸‰åŠ å…¥ç¼–è¾‘"
     */
    private String message;
    
    /**
     * ç¼–è¾‘åŠ¨ä½œï¼šåŸå°ä¸åŠ¨é€ä¼ ç»™å…¶ä»–ç”¨æˆ·
     */
    private String editAction;
    
    /**
     * ç”¨æˆ·ä¿¡æ¯ï¼šå½“å‰æ“ä½œç”¨æˆ·çš„ä¿¡æ¯
     */
    private UserVO user;
}
```

---

## ä¸‰ã€å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹

### 3.1 é˜¶æ®µ1ï¼šå»ºç«‹è¿æ¥ï¼ˆHandshakeï¼‰

```
å®¢æˆ·ç«¯è¯·æ±‚: ws://localhost:8080/ws/picture/edit?pictureId=123
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ã€1. WsHandshakeInterceptor æ‹¦æˆªã€‘                         â”‚
â”‚    â”œâ”€ å‰ç«¯å‘è¯·æ±‚æ—¶ä¼ é€’ pictureId å‚æ•°ï¼Œè¿›è¡Œæå–                   â”‚
â”‚    â”œâ”€ ä» Session ä¸­è·å–ç™»å½•ç”¨æˆ·                                â”‚
â”‚    â”œâ”€ æ ¡éªŒå›¾ç‰‡æ˜¯å¦å­˜åœ¨                                         â”‚
â”‚    â”œâ”€ æ ¡éªŒæ˜¯å¦æ˜¯å›¢é˜Ÿç©ºé—´                                       â”‚
â”‚    â”œâ”€ æ ¡éªŒç”¨æˆ·æ˜¯å¦æœ‰ç¼–è¾‘æƒé™ï¼ˆSpaceUserAuthManagerï¼‰            â”‚
â”‚    â””â”€ å°† userã€userIdã€pictureId å­˜å…¥ WebSocket Session       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ã€2. afterConnectionEstablished å›è°ƒã€‘                      â”‚
â”‚    â”œâ”€ ä» session.attributes è·å– pictureId å’Œ user            â”‚
â”‚    â”œâ”€ å°† session åŠ å…¥ pictureSessions[pictureId] é›†åˆ         â”‚
â”‚    â””â”€ å¹¿æ’­æ¶ˆæ¯ï¼šã€Œç”¨æˆ· XXX åŠ å…¥ç¼–è¾‘ã€                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç 

```java
@Override
public boolean beforeHandshake(ServerHttpRequest request, 
                               ServerHttpResponse response,
                               WebSocketHandler wsHandler, 
                               Map<String, Object> attributes) {
    // 1. è·å–HttpServletRequest
    HttpServletRequest servletRequest = ((ServletServerHttpRequest) request).getServletRequest();
    
    // 2. è·å–å‚æ•°
    String pictureId = servletRequest.getParameter("pictureId");
    if(StrUtil.isBlank(pictureId)) {
        log.error("ç¼ºå°‘å›¾ç‰‡å‚æ•°ï¼Œæ‹’ç»æ¡æ‰‹");
        return false;
    }
    
    // 3. æ ¡éªŒç”¨æˆ·ç™»å½•
    User loginUser = userService.getLoginUser(servletRequest);
    if(ObjectUtil.isEmpty(loginUser)) {
        log.error("ç”¨æˆ·æœªç™»å½•ï¼Œæ‹’ç»æ¡æ‰‹");
        return false;
    }
    
    // 4. æ ¡éªŒå›¾ç‰‡å’Œç©ºé—´æƒé™
    Picture picture = pictureService.getById(pictureId);
    Space space = spaceService.getById(picture.getSpaceId());
    List<String> permissionList = spaceUserAuthManager.getPermissionList(space, loginUser);
    if(!permissionList.contains(SpaceUserPermissionConstant.PICTURE_EDIT)) {
        log.error("ç”¨æˆ·æ²¡æœ‰ç¼–è¾‘æƒé™ï¼Œæ‹’ç»æ¡æ‰‹");
        return false;
    }
    
    // 5. è®¾ç½®Sessionå±æ€§
    attributes.put("user", loginUser);
    attributes.put("userId", loginUser.getId());
    attributes.put("pictureId", Long.valueOf(pictureId));
    
    return true;
}
```

**æŠ€æœ¯äº®ç‚¹ï¼š**
- âœ… æ¡æ‰‹é˜¶æ®µå°±å®Œæˆæƒé™æ ¡éªŒï¼Œæ‹’ç»éæ³•è¿æ¥
- âœ… åˆ©ç”¨ WebSocket Session Attributes ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯
- âœ… è¿æ¥æˆåŠŸç«‹å³å¹¿æ’­é€šçŸ¥ï¼Œå®ç°å®æ—¶æ„ŸçŸ¥

---

### 3.2 é˜¶æ®µ2ï¼šæ¶ˆæ¯æ¥æ”¶ä¸åˆ†å‘ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰

```
å‰ç«¯å‘é€æ¶ˆæ¯ (JSONæ ¼å¼)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€1. handleTextMessage æ¥æ”¶ã€‘                              â”‚
â”‚      â”œâ”€ è§£æ JSON â†’ PictureEditRequestMessage              â”‚
â”‚      â”œâ”€ ä» session.attributes è·å– pictureIdã€user         â”‚
â”‚      â””â”€ è°ƒç”¨ pictureEditEventProducer.publishEvent()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€2. Disruptor ç”Ÿäº§è€…ã€‘(PictureEditEventProducer)          â”‚
â”‚      â”œâ”€ è·å– RingBuffer ä¸‹ä¸€ä¸ªä½ç½®: ringBuffer.next()      â”‚
â”‚      â”œâ”€ è·å–äº‹ä»¶å¯¹è±¡: event = ringBuffer.get(next)         â”‚
â”‚      â”œâ”€ å¡«å……äº‹ä»¶æ•°æ®: event.setSession(), setUser()...     â”‚
â”‚      â””â”€ å‘å¸ƒäº‹ä»¶: ringBuffer.publish(next)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã€3. Disruptor æ¶ˆè´¹è€…ã€‘(PictureEditEventWorkHandler)       â”‚
â”‚      â”œâ”€ onEvent() æ–¹æ³•è¢«å¼‚æ­¥è°ƒç”¨                           â”‚
â”‚      â”œâ”€ ä» event ä¸­æå–æ¶ˆæ¯ç±»å‹                            â”‚
â”‚      â””â”€ æ ¹æ®ç±»å‹åˆ†å‘åˆ°ä¸åŒå¤„ç†æ–¹æ³•                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ENTER_EDIT  â”‚ EXIT_EDIT   â”‚ EDIT_ACTION â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç 

```java
@Override
protected void handleTextMessage(WebSocketSession session, TextMessage message) {
    // 1. è§£ææ¶ˆæ¯
    PictureEditRequestMessage requestMessage = 
        JSONUtil.toBean(message.getPayload(), PictureEditRequestMessage.class);
    
    // 2. è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯
    Long pictureId = (Long)session.getAttributes().get("pictureId");
    User user = (User)session.getAttributes().get("user");
    
    // 3. å‘å¸ƒäº‹ä»¶åˆ°Disruptorï¼ˆå¼‚æ­¥è§£è€¦ï¼‰
    pictureEditEventProducer.publishEvent(requestMessage, session, user, pictureId);
}
```

**æŠ€æœ¯äº®ç‚¹ï¼š**

- âœ… **å¼‚æ­¥è§£è€¦**ï¼š`handleTextMessage` åªè´Ÿè´£æ¥æ”¶å¹¶å‘å¸ƒäº‹ä»¶ï¼Œç«‹å³è¿”å›ï¼Œä¸é˜»å¡
- âœ… **èƒŒå‹æ§åˆ¶**ï¼šDisruptorçš„ 256K ç¯å½¢é˜Ÿåˆ—å¯å®¹çº³å¤§é‡å¹¶å‘è¯·æ±‚
- âœ… **é¡ºåºä¿è¯**ï¼šåŒä¸€å›¾ç‰‡çš„äº‹ä»¶æŒ‰åºæ¶ˆè´¹

---

### 3.3 é˜¶æ®µ3ï¼šä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆä¸‰ç§æ¶ˆæ¯ç±»å‹ï¼‰

#### ç±»å‹1ï¼šENTER_EDITï¼ˆè¿›å…¥ç¼–è¾‘çŠ¶æ€ï¼‰

```java
public void handleEnterEditMessage(PictureEditRequestMessage message, 
                                    WebSocketSession session, 
                                    User user, 
                                    Long pictureId) throws IOException {
    // 1. æ£€æŸ¥æ˜¯å¦æœ‰äººæ­£åœ¨ç¼–è¾‘ï¼ˆåˆ†å¸ƒå¼é”æ£€æŸ¥ï¼‰
    if(!pictureEditingUsers.containsKey(pictureId)) {
        // 2. è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç¼–è¾‘è€…
        pictureEditingUsers.put(pictureId, user.getId());
        
        // 3. æ„é€ å“åº”æ¶ˆæ¯
        PictureEditResponseMessage response = new PictureEditResponseMessage();
        response.setType("ENTER_EDIT");
        response.setMessage(String.format("ç”¨æˆ· %s å¼€å§‹ç¼–è¾‘å›¾ç‰‡", user.getUserName()));
        response.setUser(userService.getUserVO(user));
        
        // 4. å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
        broadcastToPicture(pictureId, response);
    }
}
```

**å…³é”®é€»è¾‘ï¼š**

- âœ… ä½¿ç”¨ `pictureEditingUsers` ä½œä¸ºåˆ†å¸ƒå¼é”ï¼ˆç‹¬å é”ï¼‰
- âœ… **äº’æ–¥ç¼–è¾‘**ï¼šåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç”¨æˆ·èƒ½ç¼–è¾‘
- âœ… å¹¿æ’­é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œå‰ç«¯å¯æ®æ­¤æ˜¾ç¤º"æ­£åœ¨ç¼–è¾‘"çŠ¶æ€

---

#### ç±»å‹2ï¼šEDIT_ACTIONï¼ˆæ‰§è¡Œç¼–è¾‘æ“ä½œï¼‰

```java
public void handleEditActionMessage(PictureEditRequestMessage message, 
                                     WebSocketSession session, 
                                     User user, 
                                     Long pictureId) throws IOException {
    // 1. è·å–å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ID
    Long editingUserId = pictureEditingUsers.get(pictureId);
    
    // 2. è§£æç¼–è¾‘åŠ¨ä½œç±»å‹
    String editAction = message.getEditAction();
    PictureEditActionEnum actionEnum = PictureEditActionEnum.getEnumByValue(editAction);
    
    // 3. ã€å…³é”®æ ¡éªŒã€‘åªæœ‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·æ‰èƒ½æ‰§è¡Œæ“ä½œ
    if(editingUserId != null && editingUserId.equals(user.getId())) {
        // 4. æ„é€ å“åº”æ¶ˆæ¯
        PictureEditResponseMessage response = new PictureEditResponseMessage();
        response.setType("EDIT_ACTION");
        response.setMessage(String.format("%s æ‰§è¡Œ %s æ“ä½œ", 
                            user.getUserName(), actionEnum.getText()));
        response.setEditAction(editAction); // åŸå°ä¸åŠ¨ä¼ é€’åŠ¨ä½œ
        response.setUser(userService.getUserVO(user));
        
        // 5. ã€é‡ç‚¹ã€‘å¹¿æ’­ç»™é™¤è‡ªå·±ä¹‹å¤–çš„å…¶ä»–ç”¨æˆ·
        broadcastToPicture(pictureId, response, session); // æ’é™¤è‡ªå·±
    }
}
```

**æŠ€æœ¯äº®ç‚¹ï¼š**

- âœ… **æƒé™äºŒæ¬¡æ ¡éªŒ**ï¼šåªæœ‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·æ‰èƒ½æ‰§è¡Œæ“ä½œ
- âœ… **æ“ä½œé€ä¼ **ï¼šåç«¯ä¸å¤„ç†å…·ä½“é€»è¾‘ï¼Œåªå¹¿æ’­æ“ä½œæŒ‡ä»¤
- âœ… **æ’é™¤å‘é€è€…**ï¼šé¿å…é‡å¤æ‰§è¡Œï¼ˆä¾‹å¦‚æ”¾å¤§ä¸¤æ¬¡ï¼‰
- âœ… æ”¯æŒå››ç§æ“ä½œï¼š`ZOOM_IN`ã€`ZOOM_OUT`ã€`ROTATE_LEFT`ã€`ROTATE_RIGHT`

---

#### ç±»å‹3ï¼šEXIT_EDITï¼ˆé€€å‡ºç¼–è¾‘çŠ¶æ€ï¼‰

```java
public void handleExitEditMessage(PictureEditRequestMessage message, 
                                   WebSocketSession session, 
                                   User user, 
                                   Long pictureId) throws IOException {
    // 1. è·å–å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ID
    Long editingUserId = pictureEditingUsers.get(pictureId);
    
    // 2. åªæœ‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·æ‰èƒ½é€€å‡º
    if(editingUserId != null && editingUserId.equals(user.getId())) {
        // 3. ç§»é™¤ç¼–è¾‘é”
        pictureEditingUsers.remove(pictureId);
        
        // 4. æ„é€ å“åº”æ¶ˆæ¯
        PictureEditResponseMessage response = new PictureEditResponseMessage();
        response.setType("EXIT_EDIT");
        response.setMessage(String.format("ç”¨æˆ· %s é€€å‡ºç¼–è¾‘å›¾ç‰‡", user.getUserName()));
        response.setUser(userService.getUserVO(user));
        
        // 5. å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·
        broadcastToPicture(pictureId, response);
    }
}
```

**å…³é”®è®¾è®¡ï¼š**

- âœ… é‡Šæ”¾åˆ†å¸ƒå¼é”ï¼Œå…è®¸å…¶ä»–ç”¨æˆ·è¿›å…¥ç¼–è¾‘
- âœ… å¹¿æ’­é€šçŸ¥æ‰€æœ‰äººï¼Œå‰ç«¯è§£é™¤UIé™åˆ¶

---

### 3.4 é˜¶æ®µ4ï¼šæ¶ˆæ¯å¹¿æ’­æœºåˆ¶ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰

```java
public void broadcastToPicture(Long pictureId, 
                                PictureEditResponseMessage response, 
                                WebSocketSession excludeSession) throws IOException {
    // 1. è·å–è¯¥å›¾ç‰‡çš„æ‰€æœ‰WebSocketä¼šè¯
    Set<WebSocketSession> sessionsSet = pictureSessions.get(pictureId);
    
    // 2. ã€å…³é”®ã€‘è§£å†³Longç±»å‹ç²¾åº¦ä¸¢å¤±é—®é¢˜
    ObjectMapper objectMapper = new ObjectMapper();
    SimpleModule module = new SimpleModule();
    module.addSerializer(Long.class, ToStringSerializer.instance);
    module.addSerializer(Long.TYPE, ToStringSerializer.instance);
    objectMapper.registerModule(module);
    
    // 3. åºåˆ—åŒ–æˆJSONå­—ç¬¦ä¸²
    String message = objectMapper.writeValueAsString(response);
    TextMessage textMessage = new TextMessage(message);
    
    // 4. éå†æ‰€æœ‰ä¼šè¯ï¼Œé€ä¸ªå‘é€
    if(CollUtil.isNotEmpty(sessionsSet)) {
        for (WebSocketSession session : sessionsSet) {
            // æ’é™¤æŒ‡å®šçš„sessionï¼ˆç”¨äºæ’é™¤å‘é€è€…è‡ªå·±ï¼‰
            if(excludeSession != null && excludeSession.equals(session)) {
                continue;
            }
            // åªå‘æ‰“å¼€çš„ä¼šè¯å‘é€
            if(session.isOpen()) {
                session.sendMessage(textMessage);
            }
        }
    }
}
```

**æŠ€æœ¯ç»†èŠ‚ï¼š**

1. âœ… **å‘å¸ƒ-è®¢é˜…æ¨¡å¼**ï¼šæ‰€æœ‰è®¢é˜…è¯¥å›¾ç‰‡çš„ç”¨æˆ·éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯
2. âœ… **Longç²¾åº¦ä¸¢å¤±å¤„ç†**ï¼šJavaScript çš„ number åªæœ‰53ä½ç²¾åº¦ï¼Œå°† Long è½¬ä¸º String 
3. âœ… **ä¼šè¯çŠ¶æ€æ£€æŸ¥**ï¼šåªå‘æ´»è·ƒè¿æ¥å‘é€ï¼Œé¿å…å¼‚å¸¸
4. âœ… **å¯é€‰æ’é™¤å‘é€è€…**ï¼šæ”¯æŒä¸¤ç§å¹¿æ’­æ¨¡å¼

---

### 3.5 é˜¶æ®µ5ï¼šè¿æ¥å…³é—­ï¼ˆèµ„æºæ¸…ç†ï¼‰

```java
@Override
public void afterConnectionClosed(WebSocketSession session, CloseStatus status) {
    // 1. ä»session.attributesè·å–ä¸Šä¸‹æ–‡
    Long pictureId = (Long)session.getAttributes().get("pictureId");
    User user = (User)session.getAttributes().get("user");
    
    // 2. ã€é‡è¦ã€‘å¦‚æœç”¨æˆ·æ­£åœ¨ç¼–è¾‘ï¼Œå¼ºåˆ¶é€€å‡ºç¼–è¾‘çŠ¶æ€
    handleExitEditMessage(null, session, user, pictureId);
    
    // 3. ä»ä¼šè¯é›†åˆä¸­ç§»é™¤
    Set<WebSocketSession> webSocketSessions = pictureSessions.get(pictureId);
    if(webSocketSessions != null) {
        webSocketSessions.remove(session);
        // å¦‚æœé›†åˆä¸ºç©ºï¼Œæ¸…ç†æ•´ä¸ªKey
        if(webSocketSessions.isEmpty()) {
            pictureSessions.remove(pictureId);
        }
    }
    
    // 4. å¹¿æ’­ç”¨æˆ·ç¦»å¼€æ¶ˆæ¯
    PictureEditResponseMessage response = new PictureEditResponseMessage();
    response.setType("INFO");
    response.setMessage(String.format("ç”¨æˆ· %s ç¦»å¼€ç¼–è¾‘", user.getUserName()));
    broadcastToPicture(pictureId, response);
}
```

**è®¾è®¡è¦ç‚¹ï¼š**
- âœ… **ä¼˜é›…é€€å‡º**ï¼šç”¨æˆ·æ–­å¼€è¿æ¥æ—¶è‡ªåŠ¨é‡Šæ”¾ç¼–è¾‘é”
- âœ… **èµ„æºå›æ”¶**ï¼šæ¸…ç†ä¼šè¯é›†åˆï¼Œé¿å…å†…å­˜æ³„æ¼
- âœ… **é€šçŸ¥å…¶ä»–ç”¨æˆ·**ï¼šå®æ—¶æ›´æ–°åœ¨çº¿çŠ¶æ€

---

## å››ã€Disruptor é«˜æ€§èƒ½å¼‚æ­¥å¤„ç†

### 4.1 ä¸ºä»€ä¹ˆä½¿ç”¨ Disruptorï¼Ÿ

| å¯¹æ¯”é¡¹ | ä¼ ç»Ÿé˜»å¡é˜Ÿåˆ— | Disruptor |
|--------|-------------|-----------|
| **æ•°æ®ç»“æ„** | é“¾è¡¨ï¼ˆLinkedBlockingQueueï¼‰ | ç¯å½¢æ•°ç»„ï¼ˆRingBufferï¼‰ |
| **é”æœºåˆ¶** | ReentrantLockï¼ˆé‡é‡çº§é”ï¼‰ | CASæ— é” |
| **ä¼ªå…±äº«** | å­˜åœ¨ | é€šè¿‡ç¼“å­˜è¡Œå¡«å……æ¶ˆé™¤ |
| **ååé‡** | ~100ä¸‡ops/s | ~1000ä¸‡ops/s |
| **å†…å­˜åˆ†é…** | é¢‘ç¹åˆ›å»ºå¯¹è±¡ | é¢„åˆ†é…ï¼Œé›¶GC |
| **æ€§èƒ½æå‡** | åŸºå‡† | **10å€ä»¥ä¸Š** |

### 4.2 Disruptor é…ç½®è¯¦è§£

```java
@Configuration
public class PictureEditEventDisruptorConfig {
    
    @Resource
    private PictureEditEventWorkHandler pictureEditEventWorkHandler;
    
    @Bean("PictureEditEventDisruptor")
    public Disruptor<PictureEditEvent> messageModelRingBuffer() {
        // 1. ç¼“å†²åŒºå¤§å°ï¼š256Kï¼ˆå¿…é¡»æ˜¯2çš„å¹‚æ¬¡ï¼‰
        int bufferSize = 1024 * 256; // 262144
        
        // 2. åˆ›å»ºDisruptorå®ä¾‹
        Disruptor<PictureEditEvent> disruptor = new Disruptor<>(
            PictureEditEvent::new,  // äº‹ä»¶å·¥å‚ï¼ˆå¯¹è±¡æ± ï¼‰
            bufferSize,
            ThreadFactoryBuilder.create()
                .setNamePrefix("PictureEditEventDisruptor-")
                .build()
        );
        
        // 3. ç»‘å®šæ¶ˆè´¹è€…ï¼ˆWorkHandleræ¨¡å¼ï¼‰
        disruptor.handleEventsWithWorkerPool(pictureEditEventWorkHandler);
        
        // 4. å¯åŠ¨Disruptor
        disruptor.start();
        
        return disruptor;
    }
}
```

**å…³é”®å‚æ•°ï¼š**

- **bufferSize = 256K**ï¼šå¯å®¹çº³26ä¸‡å¹¶å‘è¯·æ±‚
- **å¿…é¡»æ˜¯2çš„å¹‚æ¬¡**ï¼šåˆ©ç”¨ä½è¿ç®—ä¼˜åŒ–å–æ¨¡ï¼ˆ`index = sequence & (bufferSize - 1)`ï¼‰
- **é¢„åˆ†é…å¯¹è±¡**ï¼šå¯åŠ¨æ—¶åˆ›å»ºæ‰€æœ‰Eventå¯¹è±¡ï¼Œè¿è¡Œæ—¶é›¶GC

---

### 4.3 ç”Ÿäº§è€…å·¥ä½œæµç¨‹

```java
@Component
public class PictureEditEventProducer {
    
    @Resource
    Disruptor<PictureEditEvent> pictureEditEventDisruptor;
    
    public void publishEvent(PictureEditRequestMessage message, 
                             WebSocketSession session, 
                             User user, 
                             Long pictureId) {
        // 1. è·å–ç¯å½¢ç¼“å†²åŒº
        RingBuffer<PictureEditEvent> ringBuffer = disruptor.getRingBuffer();
        
        // 2. ã€å…³é”®ã€‘è·å–ä¸‹ä¸€ä¸ªå¯ç”¨ä½ç½®ï¼ˆCASæ“ä½œï¼‰
        long next = ringBuffer.next(); // é˜»å¡ç­‰å¾…ç›´åˆ°æœ‰å¯ç”¨ä½ç½®
        
        // 3. è·å–è¯¥ä½ç½®çš„äº‹ä»¶å¯¹è±¡ï¼ˆå¯¹è±¡å¤ç”¨ï¼‰
        PictureEditEvent event = ringBuffer.get(next);
        
        // 4. å¡«å……äº‹ä»¶æ•°æ®
        event.setSession(session);
        event.setPictureEditRequestMessage(message);
        event.setUser(user);
        event.setPictureId(pictureId);
        
        // 5. å‘å¸ƒäº‹ä»¶ï¼ˆCASæ›´æ–°åºå·ï¼‰
        ringBuffer.publish(next);
    }
}
```

**é«˜æ€§èƒ½åŸç†ï¼š**

1. âœ… **æ— é”è®¾è®¡**ï¼š`ringBuffer.next()` ä½¿ç”¨CASæ“ä½œï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢
2. âœ… **å¯¹è±¡å¤ç”¨**ï¼šEvent å¯¹è±¡é¢„åˆ†é…ï¼Œåªä¿®æ”¹å±æ€§ï¼Œä¸åˆ›å»ºæ–°å¯¹è±¡
3. âœ… **æ‰¹é‡å‘å¸ƒ**ï¼šå¯ä¸€æ¬¡å‘å¸ƒå¤šä¸ªäº‹ä»¶ï¼Œå‡å°‘volatileå†™å¼€é”€

---

### 4.4 æ¶ˆè´¹è€…å·¥ä½œæµç¨‹

```java
@Component
public class PictureEditEventWorkHandler implements WorkHandler<PictureEditEvent> {
    
    @Resource
    PictureEditHandler pictureEditHandler;
    
    @Override
    public void onEvent(PictureEditEvent event) throws Exception {
        // 1. æå–äº‹ä»¶æ•°æ®
        PictureEditRequestMessage message = event.getPictureEditRequestMessage();
        String type = message.getType();
        
        // 2. æ ¹æ®ç±»å‹åˆ†å‘å¤„ç†
        switch (PictureEditMessageTypeEnum.getEnumByValue(type)) {
            case ENTER_EDIT:
                pictureEditHandler.handleEnterEditMessage(...);
                break;
            case EXIT_EDIT:
                pictureEditHandler.handleExitEditMessage(...);
                break;
            case EDIT_ACTION:
                pictureEditHandler.handleEditActionMessage(...);
                break;
            default:
                // å‘é€é”™è¯¯æ¶ˆæ¯
                ...
        }
    }
}
```

**WorkHandler vs EventHandlerï¼š**

- **WorkHandler**ï¼šå¤šä¸ªæ¶ˆè´¹è€…ç«äº‰æ¶ˆè´¹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ï¼Œé€‚åˆCPUå¯†é›†å‹ä»»åŠ¡
- **EventHandler**ï¼šæ¯ä¸ªæ¶ˆè´¹è€…éƒ½å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼ˆå¹¿æ’­æ¨¡å¼ï¼‰

---

### 4.5 ä¼˜é›…åœæœº

```java
@PreDestroy
public void close() {
    // ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰äº‹ä»¶å¤„ç†å®Œæ¯•åå…³é—­
    pictureEditEventDisruptor.shutdown();
}
```

---

### 4.6 å®Œæ•´çš„æ¶ˆæ¯å¤„ç†æµç¨‹è¯¦è§£ï¼ˆé¢è¯•é‡ç‚¹ï¼‰â­â­â­â­â­

è¿™æ˜¯é¢è¯•ä¸­æœ€å®¹æ˜“è¢«é—®åˆ°çš„éƒ¨åˆ†ï¼Œéœ€è¦èƒ½å¤Ÿ**æ¸…æ™°å£è¿°**æ•´ä¸ªæ¶ˆæ¯ä»æ¥æ”¶åˆ°å¤„ç†çš„å®Œæ•´æµç¨‹

#### 4.6.1 æ•´ä½“æµç¨‹æ¦‚è§ˆ

```
ã€é˜¶æ®µ1ï¼šå¿«é€Ÿæ¥æ”¶ã€‘WebSocketçº¿ç¨‹ (0.1ms)
         â†“
ã€é˜¶æ®µ2ï¼šå‘å¸ƒäº‹ä»¶ã€‘ç”Ÿäº§è€…å‘å¸ƒåˆ°RingBuffer (å‡ å¾®ç§’)
         â†“
ã€é˜¶æ®µ3ï¼šå¼‚æ­¥ä¼ é€’ã€‘256Kç¯å½¢é˜Ÿåˆ—ç¼“å†²
         â†“
ã€é˜¶æ®µ4ï¼šç‹¬ç«‹å¤„ç†ã€‘æ¶ˆè´¹è€…çº¿ç¨‹å¤„ç†ä¸šåŠ¡ (20-50ms)
         â†“
ã€é˜¶æ®µ5ï¼šæ¶ˆæ¯å¹¿æ’­ã€‘å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
```

#### 4.6.2 é˜¶æ®µ1ï¼šWebSocketæ¥æ”¶æ¶ˆæ¯ï¼ˆç”Ÿäº§è€…å…¥å£ï¼‰

**åœºæ™¯ï¼š** å‰ç«¯ç”¨æˆ·ç‚¹å‡»'æ”¾å¤§'æŒ‰é’®ï¼Œå‘é€WebSocketæ¶ˆæ¯

```java
@Override
protected void handleTextMessage(WebSocketSession session, TextMessage message) {
    // 1. è§£æJSONæ¶ˆæ¯ (~0.01ms)
    PictureEditRequestMessage requestMessage = 
        JSONUtil.toBean(message.getPayload(), PictureEditRequestMessage.class);
    
    // 2. è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯ (~0.01ms)
    Long pictureId = (Long)session.getAttributes().get("pictureId");
    User user = (User)session.getAttributes().get("user");
    
    // 3. ç«‹å³å‘å¸ƒäº‹ä»¶ï¼Œä¸å¤„ç†ä¸šåŠ¡é€»è¾‘ (~0.08ms)
    pictureEditEventProducer.publishEvent(requestMessage, session, user, pictureId);
    
    // âœ… æ–¹æ³•ç»“æŸï¼Œæ€»è€—æ—¶çº¦0.1msï¼Œç«‹å³è¿”å›
    // WebSocketçº¿ç¨‹ä¸ä¼šè¢«ä¸šåŠ¡é€»è¾‘é˜»å¡ï¼Œå¯ä»¥ç»§ç»­æ¥æ”¶æ–°æ¶ˆæ¯
}
```

**å…³é”®ç‚¹ï¼š**

- âœ… **æé€Ÿè¿”å›**ï¼šåªåšè§£æå’Œå‘å¸ƒï¼Œä¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘
- âœ… **ä¸é˜»å¡**ï¼šWebSocketçº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–æ¶ˆæ¯
- âœ… **è§£è€¦è®¾è®¡**ï¼šæ¥æ”¶å’Œå¤„ç†å®Œå…¨åˆ†ç¦»

#### 4.6.3 é˜¶æ®µ2ï¼šå‘å¸ƒäº‹ä»¶åˆ°Disruptorï¼ˆç”Ÿäº§ç«¯ï¼‰

**æ ¸å¿ƒæµç¨‹ï¼š**

```java
public void publishEvent(...) {
    // 1. è·å–ç¯å½¢ç¼“å†²åŒº
    RingBuffer<PictureEditEvent> ringBuffer = disruptor.getRingBuffer();
    
    // 2. ã€å…³é”®ã€‘è·å–ä¸‹ä¸€ä¸ªå¯ç”¨ä½ç½® - CASæ— é”æ“ä½œ
    //    å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œè¿™é‡Œä¼šé˜»å¡ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹
    long next = ringBuffer.next();
    
    // 3. æ ¹æ®ä½ç½®è·å–é¢„åˆ†é…çš„äº‹ä»¶å¯¹è±¡ï¼ˆå¯¹è±¡å¤ç”¨ï¼Œé›¶GCï¼‰
    PictureEditEvent event = ringBuffer.get(next);
    
    // 4. å¡«å……äº‹ä»¶æ•°æ®ï¼ˆåªæ˜¯ä¿®æ”¹å¯¹è±¡å±æ€§ï¼Œä¸åˆ›å»ºæ–°å¯¹è±¡ï¼‰
    event.setSession(session);
    event.setPictureEditRequestMessage(message);
    event.setUser(user);
    event.setPictureId(pictureId);
    
    // 5. å‘å¸ƒäº‹ä»¶ - CASæ›´æ–°åºå·ï¼Œæ¶ˆè´¹è€…å°±èƒ½çœ‹åˆ°äº†
    ringBuffer.publish(next);
    
    // âœ… æ•´ä¸ªè¿‡ç¨‹å‡ å¾®ç§’ï¼Œæ²¡æœ‰ä»»ä½•é”
}
```

**äº”ä¸ªå…³é”®æ­¥éª¤çš„æŠ€æœ¯ç»†èŠ‚ï¼š**

| æ­¥éª¤ | æ“ä½œ | æŠ€æœ¯åŸç† | è€—æ—¶ |
|------|------|---------|------|
| **Step 1** | è·å–RingBuffer | ç›´æ¥è¿”å›å¼•ç”¨ | çº³ç§’çº§ |
| **Step 2** | ringBuffer.next() | CASæ“ä½œè·å–åºå· | ~1å¾®ç§’ |
| **Step 3** | ringBuffer.get(next) | æ•°ç»„è®¿é—® event[index] | çº³ç§’çº§ |
| **Step 4** | å¡«å……æ•°æ® | ä¿®æ”¹å¯¹è±¡å±æ€§ | ~2å¾®ç§’ |
| **Step 5** | ringBuffer.publish(next) | CASæ›´æ–°åºå· | ~1å¾®ç§’ |

**ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ**

1. **æ— é”è®¾è®¡**ï¼šåªæœ‰CASæ“ä½œï¼Œä¸éœ€è¦åŠ é”ï¼Œä¸ä¼šè¢«é˜»å¡
2. **å¯¹è±¡å¤ç”¨**ï¼šEventå¯¹è±¡æ˜¯é¢„åˆ†é…çš„ï¼Œåªä¿®æ”¹å±æ€§ï¼Œä¸åˆ›å»ºæ–°å¯¹è±¡
3. **æ•°ç»„è®¿é—®**ï¼šRingBufferåº•å±‚æ˜¯æ•°ç»„ï¼Œè®¿é—®é€Ÿåº¦æå¿«

#### 4.6.4 é˜¶æ®µ3ï¼šç¯å½¢é˜Ÿåˆ—ä¼ é€’ï¼ˆRingBufferåŸç†ï¼‰

**æ•°æ®ç»“æ„ï¼š**

```
RingBuffer: ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ï¼ˆ256Kï¼‰

[Event0][Event1][Event2]...[Event262143]
    â†‘                              â†‘
ç”Ÿäº§è€…åºå·=5                    æ¶ˆè´¹è€…åºå·=3

å·¥ä½œåŸç†ï¼š
- ç”Ÿäº§è€…å¾€å‰èµ°ï¼Œå†™å…¥æ•°æ®
- æ¶ˆè´¹è€…ä¹Ÿå¾€å‰èµ°ï¼Œè¯»å–æ•°æ®
- åˆ°è¾¾æœ«å°¾æ—¶å›åˆ°å¼€å¤´ï¼Œå¾ªç¯ä½¿ç”¨ï¼ˆå–æ¨¡ï¼šindex = sequence % bufferSizeï¼‰
```

**åºå·æœºåˆ¶ï¼ˆSequenceï¼‰ï¼š**

```java
// å…¨å±€å…±äº«çš„åºå·
volatile long producerSequence = 0;  // ç”Ÿäº§è€…åºå·
volatile long consumerSequence = 0;  // æ¶ˆè´¹è€…åºå·

// ç”Ÿäº§è€…å‘å¸ƒ
producerSequence++; // CASæ“ä½œ

// æ¶ˆè´¹è€…åˆ¤æ–­æ˜¯å¦æœ‰æ–°äº‹ä»¶
if (consumerSequence < producerSequence) {
    // æœ‰æ–°äº‹ä»¶ï¼Œå¯ä»¥æ¶ˆè´¹
    Event event = ringBuffer[consumerSequence % bufferSize];
    processEvent(event);
    consumerSequence++;
}
```

**å…³é”®ä¼˜åŒ–ï¼šæ¶ˆé™¤ä¼ªå…±äº«ï¼ˆCache Line Paddingï¼‰**

```java
// é—®é¢˜ï¼šå¦‚æœä¸¤ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªCPUç¼“å­˜è¡Œï¼ˆ64å­—èŠ‚ï¼‰ï¼Œä¼šå‘ç”Ÿä¼ªå…±äº«
// ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å˜é‡Aï¼Œå¯¼è‡´æ•´ä¸ªç¼“å­˜è¡Œå¤±æ•ˆï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è®¿é—®å˜é‡Béœ€è¦é‡æ–°åŠ è½½

// è§£å†³æ–¹æ¡ˆï¼šå¡«å……æ— ç”¨å­—æ®µï¼Œè®©å…³é”®å˜é‡ç‹¬å ä¸€ä¸ªç¼“å­˜è¡Œ
long p1, p2, p3, p4, p5, p6, p7; // å¡«å……56å­—èŠ‚
volatile long sequence;          // å…³é”®å˜é‡8å­—èŠ‚
long p8, p9, p10, p11, p12, p13, p14; // å¡«å……56å­—èŠ‚
// æ€»å…±64å­—èŠ‚ï¼Œæ­£å¥½ä¸€ä¸ªç¼“å­˜è¡Œ
```

#### 4.6.5 é˜¶æ®µ4ï¼šæ¶ˆè´¹è€…å¤„ç†äº‹ä»¶

**ç­‰å¾…ç­–ç•¥ï¼š**

```java
// æ¶ˆè´¹è€…çº¿ç¨‹è¿›å…¥å¾ªç¯ï¼Œä¸æ–­æ£€æŸ¥æ˜¯å¦æœ‰æ–°äº‹ä»¶
while (running) {
    // 1. ç­‰å¾…æ–°äº‹ä»¶ï¼ˆä½¿ç”¨BlockingWaitStrategyï¼‰
    long availableSequence = waitFor(consumerSequence + 1);
    
    // 2. å¦‚æœæœ‰æ–°äº‹ä»¶ï¼Œå¤„ç†å®ƒ
    if (availableSequence >= consumerSequence + 1) {
        for (long seq = consumerSequence + 1; seq <= availableSequence; seq++) {
            PictureEditEvent event = ringBuffer.get(seq);
            onEvent(event); // è°ƒç”¨æˆ‘ä»¬çš„å¤„ç†æ–¹æ³•
        }
        consumerSequence = availableSequence;
    }
}
```

**ä¸šåŠ¡å¤„ç†ï¼š**

```java
@Override
public void onEvent(PictureEditEvent event) throws Exception {
    // 1. æå–äº‹ä»¶æ•°æ®
    PictureEditRequestMessage message = event.getPictureEditRequestMessage();
    String type = message.getType();
    
    // 2. æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘å¤„ç†ï¼ˆè¿™é‡Œæ‰æ˜¯çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼‰
    switch (PictureEditMessageTypeEnum.getEnumByValue(type)) {
        case ENTER_EDIT:
            // æ£€æŸ¥æ˜¯å¦æœ‰äººåœ¨ç¼–è¾‘ â†’ åŠ é” â†’ å¹¿æ’­
            pictureEditHandler.handleEnterEditMessage(...);
            break;
            
        case EDIT_ACTION:
            // æƒé™æ ¡éªŒ â†’ å¹¿æ’­ç»™é™¤äº†è‡ªå·±ä¹‹å¤–çš„å…¶ä»–äºº
            pictureEditHandler.handleEditActionMessage(...);
            break;
            
        case EXIT_EDIT:
            // é‡Šæ”¾é” â†’ å¹¿æ’­
            pictureEditHandler.handleExitEditMessage(...);
            break;
            
        default:
            // å‘é€é”™è¯¯æ¶ˆæ¯
            sendErrorMessage(...);
            break;
    }
    
    // âœ… ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶20-50ms
    //    ä½†ä¸å½±å“WebSocketæ¥æ”¶æ–°æ¶ˆæ¯
}
```

#### 4.6.6 å®Œæ•´çš„æ—¶é—´çº¿åˆ†æ

**ç¤ºä¾‹ï¼šç”¨æˆ·ç‚¹å‡»'æ”¾å¤§'æŒ‰é’®**

```
T0 = 0ms      ç”¨æˆ·ç‚¹å‡»'æ”¾å¤§'æŒ‰é’®
               â†“
T1 = 50ms     æ¶ˆæ¯é€šè¿‡ç½‘ç»œåˆ°è¾¾æœåŠ¡å™¨
               â†“
T2 = 50.05ms  handleTextMessageè§£ææ¶ˆæ¯ (+0.05ms)
               â†“
T3 = 50.1ms   publishEventå‘å¸ƒåˆ°Disruptor (+0.05ms)
               âœ… WebSocketçº¿ç¨‹è¿”å›ï¼Œå¯ä»¥æ¥æ”¶æ–°æ¶ˆæ¯äº†
               â†“
T4 = 55ms     æ¶ˆè´¹è€…ä»é˜Ÿåˆ—æ‹¿åˆ°äº‹ä»¶ (+5mså»¶è¿Ÿ)
               â†“
T5 = 75ms     æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆæƒé™æ ¡éªŒã€å¹¿æ’­ç­‰ï¼‰ (+20ms)
               â†“
T6 = 80ms     å…¶ä»–ç”¨æˆ·æ”¶åˆ°'æ”¾å¤§'æŒ‡ä»¤ (+5msç½‘ç»œå»¶è¿Ÿ)
               â†“
T7 = 80ms     å…¶ä»–ç”¨æˆ·çš„å‰ç«¯æ‰§è¡Œæ”¾å¤§åŠ¨ç”»

æ€»å»¶è¿Ÿï¼š80msï¼ˆç”¨æˆ·æ„ŸçŸ¥ï¼‰
WebSocketçº¿ç¨‹å ç”¨æ—¶é—´ï¼š0.1msï¼ˆæçŸ­ï¼Œä¸é˜»å¡ï¼‰
```

**å¯¹æ¯”ä¼ ç»ŸåŒæ­¥å¤„ç†ï¼š**

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆåŒæ­¥å¤„ç†ï¼‰ï¼š
T0 = 0ms      ç”¨æˆ·ç‚¹å‡»'æ”¾å¤§'
T1 = 50ms     æ¶ˆæ¯åˆ°è¾¾æœåŠ¡å™¨
T2 = 50.05ms  è§£ææ¶ˆæ¯
T3 = 70ms     åŒæ­¥æ‰§è¡Œä¸šåŠ¡é€»è¾‘ (+20msï¼Œé˜»å¡WebSocketçº¿ç¨‹)
T4 = 70.1ms   WebSocketçº¿ç¨‹æ‰èƒ½è¿”å›
               âŒ è¿™20mså†…æ— æ³•æ¥æ”¶æ–°æ¶ˆæ¯
T5 = 75ms     å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·

é—®é¢˜ï¼š
- WebSocketçº¿ç¨‹è¢«é˜»å¡20ms
- å¦‚æœæœ‰100ä¸ªå¹¶å‘è¯·æ±‚ï¼Œæœ€åä¸€ä¸ªéœ€è¦ç­‰2ç§’ï¼ˆ100Ã—20msï¼‰
- ååé‡ä½
```

#### 4.6.7 æ€§èƒ½å¯¹æ¯”ä¸åˆ†æ

| æ–¹æ¡ˆ | WebSocketçº¿ç¨‹å ç”¨ | ååé‡ | å»¶è¿Ÿ | å¹¶å‘æ”¯æŒ |
|------|------------------|--------|------|---------|
| **ä¼ ç»ŸåŒæ­¥** | 20-50msï¼ˆé˜»å¡ï¼‰ | 5ä¸‡/ç§’ | 100ms | ä½ |
| **çº¿ç¨‹æ± å¼‚æ­¥** | 0.5msï¼ˆæäº¤ä»»åŠ¡ï¼‰ | 10ä¸‡/ç§’ | 50ms | ä¸­ |
| **Disruptorå¼‚æ­¥** | 0.1msï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰ | 50ä¸‡/ç§’ | 10ms | é«˜ |

**Disruptoræ€§èƒ½æå‡çš„åŸå› ï¼š**

1. **æ— é”è®¾è®¡**ï¼š
   - ä¼ ç»Ÿé˜Ÿåˆ—ï¼šReentrantLockåŠ é”ï¼Œçº¿ç¨‹ç«äº‰ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢
   - Disruptorï¼šCASæ“ä½œï¼Œæ— ç«äº‰ï¼Œæ— ä¸Šä¸‹æ–‡åˆ‡æ¢
   - æ€§èƒ½å·®è·ï¼š3-5å€

2. **é›¶GC**ï¼š
   - ä¼ ç»Ÿé˜Ÿåˆ—ï¼šé¢‘ç¹åˆ›å»ºTaskå¯¹è±¡ï¼ŒGCå‹åŠ›å¤§
   - Disruptorï¼šé¢„åˆ†é…Eventå¯¹è±¡ï¼Œåªä¿®æ”¹å±æ€§
   - æ€§èƒ½å·®è·ï¼š2-3å€

3. **æ¶ˆé™¤ä¼ªå…±äº«**ï¼š
   - ä¼ ç»Ÿé˜Ÿåˆ—ï¼šå¤šä¸ªå˜é‡å¯èƒ½åœ¨åŒä¸€ç¼“å­˜è¡Œ
   - Disruptorï¼šç¼“å­˜è¡Œå¡«å……ï¼Œæ¯ä¸ªå…³é”®å˜é‡ç‹¬å ä¸€è¡Œ
   - æ€§èƒ½å·®è·ï¼š1.5-2å€

4. **æ‰¹é‡å¤„ç†**ï¼š
   - Disruptoræ”¯æŒæ‰¹é‡å‘å¸ƒå’Œæ‰¹é‡æ¶ˆè´¹
   - å‡å°‘volatileå†™æ“ä½œ
   - æ€§èƒ½å·®è·ï¼š1.5å€

**ç»¼åˆæå‡ï¼š3 Ã— 2 Ã— 1.5 Ã— 1.5 â‰ˆ 13å€ï¼ˆç†è®ºå€¼ï¼‰**  
**å®æµ‹æå‡ï¼š10å€å·¦å³**

#### 4.6.8 é¢è¯•å£è¿°ç‰ˆæœ¬ï¼ˆæ¨èèƒŒè¯µï¼‰

ä¸šåŠ¡æµç¨‹ï¼š



**å®Œæ•´ç‰ˆï¼ˆ3-4åˆ†é’Ÿï¼‰ï¼š**

> "è®©æˆ‘è¯¦ç»†è¯´ä¸€ä¸‹æ¶ˆæ¯å¤„ç†çš„å®Œæ•´æµç¨‹ï¼š
>
> **ç¬¬ä¸€æ­¥ï¼ŒWebSocketæ¥æ”¶æ¶ˆæ¯ã€‚** å‰ç«¯å‘é€ä¸€ä¸ªç¼–è¾‘æ¶ˆæ¯ï¼Œæ¯”å¦‚'æ”¾å¤§'æ“ä½œã€‚handleTextMessage æ–¹æ³•æ¥æ”¶åˆ°åï¼Œåªåšä¸‰ä»¶äº‹ï¼šè§£æJSONã€è·å–ä¸Šä¸‹æ–‡ã€è°ƒç”¨ç”Ÿäº§è€…å‘å¸ƒäº‹ä»¶ã€‚æ•´ä¸ªè¿‡ç¨‹åªéœ€è¦0.1æ¯«ç§’ï¼Œç„¶åç«‹å³è¿”å›ï¼Œä¸ä¼šé˜»å¡ã€‚
>
> **ç¬¬äºŒæ­¥ï¼Œå‘å¸ƒäº‹ä»¶åˆ°Disruptorã€‚** ç”Ÿäº§è€…è°ƒç”¨ringBuffer.next()è·å–é˜Ÿåˆ—ä½ç½®ï¼Œè¿™æ˜¯ä¸ªCASæ— é”æ“ä½œã€‚ç„¶åæ‹¿åˆ°é¢„åˆ†é…çš„äº‹ä»¶å¯¹è±¡ï¼Œå¡«å……æ•°æ®ï¼Œè°ƒç”¨ringBuffer.publish()å‘å¸ƒã€‚æ•´ä¸ªè¿‡ç¨‹å‡ å¾®ç§’ï¼Œæ²¡æœ‰ä»»ä½•é”ï¼Œä¸åˆ›å»ºæ–°å¯¹è±¡ã€‚
>
> **ç¬¬ä¸‰æ­¥ï¼Œç¯å½¢é˜Ÿåˆ—ä¼ é€’ã€‚** äº‹ä»¶è¿›å…¥256Kçš„RingBufferï¼Œè¿™æ˜¯ä¸ªé¢„åˆ†é…çš„æ•°ç»„ï¼Œè®¿é—®æå¿«ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€šè¿‡åºå·æœºåˆ¶åè°ƒï¼Œä¸éœ€è¦é”ã€‚
>
> **ç¬¬å››æ­¥ï¼Œæ¶ˆè´¹è€…å¤„ç†ã€‚** æ¶ˆè´¹è€…çº¿ç¨‹ä»é˜Ÿåˆ—å–å‡ºäº‹ä»¶ï¼Œæ ¹æ®ç±»å‹åˆ†å‘å¤„ç†ã€‚è¿™é‡Œæ‰æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚æƒé™æ ¡éªŒã€åŠ é”ã€å¹¿æ’­ç­‰ï¼Œå¯èƒ½éœ€è¦20-50æ¯«ç§’ã€‚ä½†å› ä¸ºåœ¨ç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œï¼Œä¸å½±å“WebSocketç»§ç»­æ¥æ”¶æ–°æ¶ˆæ¯ã€‚
>
> **å…³é”®ä¼˜åŠ¿ï¼š** WebSocketçº¿ç¨‹åªå ç”¨0.1æ¯«ç§’å°±è¿”å›äº†ï¼Œå¯ä»¥ç»§ç»­æ¥æ”¶æ–°æ¶ˆæ¯ã€‚ä¸šåŠ¡é€»è¾‘åœ¨åå°æ…¢æ…¢å¤„ç†ï¼Œä¸¤è€…å®Œå…¨è§£è€¦ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½æ”¯æŒ10ä¸‡å¹¶å‘è¿æ¥ï¼Œæ¶ˆæ¯å»¶è¿Ÿæ§åˆ¶åœ¨10æ¯«ç§’ä»¥å†…ã€‚"

**ç²¾ç®€ç‰ˆï¼ˆ1-2åˆ†é’Ÿï¼‰ï¼š**

> "ç®€å•æ¥è¯´åˆ†ä¸‰ä¸ªé˜¶æ®µï¼š
>
> **å¿«é€Ÿæ¥æ”¶**ï¼šWebSocketæ”¶åˆ°æ¶ˆæ¯å0.1æ¯«ç§’å°±å‘å¸ƒåˆ°Disruptorï¼Œç«‹å³è¿”å›ã€‚
>
> **å¼‚æ­¥ä¼ é€’**ï¼šäº‹ä»¶è¿›å…¥ 256K çš„ç¯å½¢é˜Ÿåˆ—ï¼Œä½¿ç”¨ CASæ— é”æ“ä½œï¼Œé¢„åˆ†é…å¯¹è±¡é›¶GCã€‚
>
> **ç‹¬ç«‹å¤„ç†**ï¼šæ¶ˆè´¹è€…çº¿ç¨‹ä»é˜Ÿåˆ—å–äº‹ä»¶ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘ 20-50 æ¯«ç§’ï¼Œä½†ä¸å½±å“ WebSocket æ¥æ”¶æ–°æ¶ˆæ¯ã€‚
>
> æ ¸å¿ƒå°±æ˜¯æ¥æ”¶å’Œå¤„ç†è§£è€¦ï¼ŒWebSocketä¸é˜»å¡ï¼Œæ€§èƒ½æ¯”ä¼ ç»Ÿæ–¹æ¡ˆæå‡10å€ã€‚"

---

## äº”ã€å¹¶å‘å®‰å…¨è®¾è®¡

### 5.1 çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„

```java
// ConcurrentHashMap ä¿è¯åŸå­æ“ä½œ
private final Map<Long, Long> pictureEditingUsers = new ConcurrentHashMap<>();
private final Map<Long, Set<WebSocketSession>> pictureSessions = new ConcurrentHashMap<>();

// ConcurrentHashMap.newKeySet() åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„Set
pictureSessions.putIfAbsent(pictureId, ConcurrentHashMap.newKeySet());
```

### 5.2 åˆ†å¸ƒå¼é”æœºåˆ¶

#### å½“å‰å®ç°

```java
// è¿›å…¥ç¼–è¾‘ï¼šæ£€æŸ¥ + è®¾ç½®
if(!pictureEditingUsers.containsKey(pictureId)) {
    pictureEditingUsers.put(pictureId, user.getId());
}

// é€€å‡ºç¼–è¾‘ï¼šé‡Šæ”¾é”
pictureEditingUsers.remove(pictureId);
```

#### æ½œåœ¨é—®é¢˜ä¸ä¼˜åŒ–

**é—®é¢˜ï¼š** `containsKey()` å’Œ `put()` ä¸æ˜¯åŸå­æ“ä½œï¼Œé«˜å¹¶å‘ä¸‹å¯èƒ½æœ‰ä¸¤ä¸ªç”¨æˆ·åŒæ—¶è¿›å…¥ç¼–è¾‘

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```java
// ä½¿ç”¨putIfAbsentä¿è¯åŸå­æ€§
Long previousUserId = pictureEditingUsers.putIfAbsent(pictureId, user.getId());
if(previousUserId == null) {
    // æˆåŠŸè·å–ç¼–è¾‘æƒé™
    broadcastToPicture(...);
} else {
    // å·²æœ‰å…¶ä»–ç”¨æˆ·åœ¨ç¼–è¾‘
    sendErrorMessage(session, "å›¾ç‰‡æ­£åœ¨è¢«ç¼–è¾‘");
}
```

### 5.3 æ¶ˆæ¯é¡ºåºæ€§ä¿è¯

- **åŒä¸€å›¾ç‰‡çš„æ¶ˆæ¯é¡ºåº**ï¼šDisruptorçš„å•çº¿ç¨‹æ¶ˆè´¹ä¿è¯
- **ä¸åŒå›¾ç‰‡çš„æ¶ˆæ¯å¹¶å‘**ï¼šWorkHandlerå¤šçº¿ç¨‹æ± å¤„ç†
- **ä¼šè¯æ“ä½œåŸå­æ€§**ï¼š`ConcurrentHashMap.newKeySet()` ä¿è¯Setæ“ä½œçº¿ç¨‹å®‰å…¨

---

## å…­ã€ç³»ç»Ÿäº®ç‚¹ä¸æŠ€æœ¯éš¾ç‚¹æ€»ç»“

### 6.1 æŠ€æœ¯äº®ç‚¹ï¼ˆé¢è¯•é‡ç‚¹ï¼‰

| äº®ç‚¹ | è¯´æ˜ | æŠ€æœ¯ä»·å€¼ |
|------|------|----------|
| **1. é«˜æ€§èƒ½å¼‚æ­¥æ¶æ„** | WebSocketæ¥æ”¶ + Disruptorå¼‚æ­¥å¤„ç†ï¼Œååé‡æå‡10å€ | â­â­â­â­â­ |
| **2. åˆ†å¸ƒå¼é”è®¾è®¡** | ä½¿ç”¨ConcurrentHashMapå®ç°è½»é‡çº§åˆ†å¸ƒå¼é”ï¼Œä¿è¯äº’æ–¥ç¼–è¾‘ | â­â­â­â­â­ |
| **3. å‘å¸ƒ-è®¢é˜…æ¨¡å¼** | æ¯å¼ å›¾ç‰‡ç»´æŠ¤è®¢é˜…è€…é›†åˆï¼Œæ”¯æŒæ¶ˆæ¯å¹¿æ’­ | â­â­â­â­ |
| **4. æƒé™åˆ†å±‚æ ¡éªŒ** | æ¡æ‰‹æ‹¦æˆªå™¨ + ä¸šåŠ¡é€»è¾‘åŒé‡æ ¡éªŒ | â­â­â­â­ |
| **5. ä¼˜é›…çš„èµ„æºç®¡ç†** | è¿æ¥å…³é—­è‡ªåŠ¨æ¸…ç†ã€ä¼˜é›…åœæœº | â­â­â­ |
| **6. ç²¾åº¦ä¸¢å¤±å¤„ç†** | Longç±»å‹è½¬Stringï¼Œè§£å†³å‰ç«¯ç²¾åº¦é—®é¢˜ | â­â­â­ |

### 6.2 æŠ€æœ¯éš¾ç‚¹

#### éš¾ç‚¹1ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ¶ˆæ¯å¤„ç†

**é—®é¢˜ï¼š** WebSocketå•çº¿ç¨‹å¤„ç†æ¶ˆæ¯ï¼Œé«˜å¹¶å‘ä¸‹ä¼šé˜»å¡

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨Disruptorå¼‚æ­¥é˜Ÿåˆ—è§£è€¦æ¥æ”¶å’Œå¤„ç†
- 256Kç¯å½¢ç¼“å†²åŒºæ”¯æŒç™¾ä¸‡çº§å¹¶å‘
- æ— é”CASæ“ä½œï¼Œé¿å…çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

#### éš¾ç‚¹2ï¼šåˆ†å¸ƒå¼é”çš„å®ç°

**é—®é¢˜ï¼š** å¦‚ä½•ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç”¨æˆ·ç¼–è¾‘å›¾ç‰‡

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨`ConcurrentHashMap`å®ç°å†…å­˜çº§åˆ†å¸ƒå¼é”
- è¿›å…¥ç¼–è¾‘å‰æ£€æŸ¥`pictureEditingUsers`
- é€€å‡ºç¼–è¾‘æˆ–æ–­å¼€è¿æ¥æ—¶è‡ªåŠ¨é‡Šæ”¾é”

#### éš¾ç‚¹3ï¼šæ¶ˆæ¯å¹¿æ’­çš„ç²¾å‡†æ§åˆ¶

**é—®é¢˜ï¼š** å¦‚ä½•å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·ï¼Œåˆé¿å…å‘é€è€…é‡å¤æ”¶åˆ°

**è§£å†³æ–¹æ¡ˆï¼š**
- ç»´æŠ¤`pictureSessions`è®°å½•æ‰€æœ‰ä¼šè¯
- `broadcastToPicture`æ”¯æŒæ’é™¤æŒ‡å®šsession
- å‘é€å‰æ£€æŸ¥ä¼šè¯æ˜¯å¦open

#### éš¾ç‚¹4ï¼šçŠ¶æ€ä¸€è‡´æ€§ä¿è¯

**é—®é¢˜ï¼š** ç”¨æˆ·å¼‚å¸¸æ–­å¼€å¦‚ä½•ä¿è¯çŠ¶æ€ä¸€è‡´

**è§£å†³æ–¹æ¡ˆï¼š**
- `afterConnectionClosed`é’©å­è‡ªåŠ¨æ¸…ç†
- åŒæ—¶æ¸…ç†ç¼–è¾‘é”å’Œä¼šè¯é›†åˆ
- å¹¿æ’­é€šçŸ¥å…¶ä»–ç”¨æˆ·

---

## ä¸ƒã€é¢è¯•è¯æœ¯ï¼ˆå®Œæ•´ç‰ˆï¼‰

### 7.1 æ ¸å¿ƒå›ç­”ï¼ˆ2åˆ†é’Ÿç‰ˆï¼‰

å½“é¢è¯•å®˜é—®"ä½ çš„ååŒç¼–è¾‘æ˜¯æ€ä¹ˆå®ç°çš„"æ—¶ï¼š

> **"æˆ‘çš„ååŒç¼–è¾‘ç³»ç»Ÿé‡‡ç”¨äº† WebSocket + Disruptor çš„é«˜æ€§èƒ½æ¶æ„ã€‚æ•´ä¸ªç³»ç»Ÿåˆ†ä¸ºå››ä¸ªæ ¸å¿ƒç¯èŠ‚ï¼š**
>
> **ç¬¬ä¸€ï¼Œè¿æ¥å»ºç«‹é˜¶æ®µã€‚** ç”¨æˆ·é€šè¿‡WebSocketè¿æ¥æœåŠ¡å™¨ï¼Œè¿æ¥å‰ä¼šç»è¿‡æ¡æ‰‹æ‹¦æˆªå™¨è¿›è¡Œæƒé™æ ¡éªŒï¼ŒåŒ…æ‹¬ç”¨æˆ·ç™»å½•çŠ¶æ€ã€å›¾ç‰‡æƒé™ã€ç©ºé—´æƒé™ç­‰å¤šé‡æ ¡éªŒï¼Œåªæœ‰é€šè¿‡æ‰å»ºç«‹è¿æ¥ã€‚åŒæ—¶ä¼šå°†ç”¨æˆ·ä¿¡æ¯å’Œå›¾ç‰‡IDå­˜å…¥Session Attributesï¼Œä¾¿äºåç»­ä½¿ç”¨ã€‚
>
> **ç¬¬äºŒï¼Œæ¶ˆæ¯å¤„ç†é˜¶æ®µã€‚** è¿™æ˜¯æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚å‰ç«¯å‘é€ç¼–è¾‘æ¶ˆæ¯åï¼Œæˆ‘ä¸æ˜¯ç›´æ¥åœ¨WebSocketçº¿ç¨‹ä¸­å¤„ç†ï¼Œè€Œæ˜¯å°†æ¶ˆæ¯å°è£…æˆäº‹ä»¶å‘å¸ƒåˆ°Disruptorç¯å½¢é˜Ÿåˆ—ä¸­ã€‚Disruptoræ˜¯LMAXå¼€æºçš„é«˜æ€§èƒ½å¹¶å‘æ¡†æ¶ï¼Œä½¿ç”¨æ— é”çš„RingBufferï¼Œæ€§èƒ½æ¯”ä¼ ç»Ÿé˜»å¡é˜Ÿåˆ—é«˜10å€ä»¥ä¸Šã€‚æˆ‘é…ç½®äº†256Kçš„ç¼“å†²åŒºå¤§å°ï¼Œå¯ä»¥åº”å¯¹ç™¾ä¸‡çº§å¹¶å‘ã€‚
>
> **ç¬¬ä¸‰ï¼Œä¸šåŠ¡é€»è¾‘å±‚ã€‚** æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å¼‚æ­¥æ¶ˆè´¹äº‹ä»¶ï¼Œæ ¹æ®æ¶ˆæ¯ç±»å‹åˆ†å‘å¤„ç†ã€‚ç³»ç»Ÿæ”¯æŒä¸‰ç§æ¶ˆæ¯ï¼šè¿›å…¥ç¼–è¾‘ã€é€€å‡ºç¼–è¾‘ã€æ‰§è¡Œæ“ä½œã€‚æˆ‘ç”¨ä¸¤ä¸ªConcurrentHashMapç»´æŠ¤çŠ¶æ€ï¼šä¸€ä¸ªè®°å½•æ¯å¼ å›¾ç‰‡å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç”¨æˆ·ï¼ˆå®ç°åˆ†å¸ƒå¼é”ï¼‰ï¼Œå¦ä¸€ä¸ªè®°å½•æ¯å¼ å›¾ç‰‡çš„æ‰€æœ‰WebSocketä¼šè¯ï¼ˆå®ç°å‘å¸ƒ-è®¢é˜…ï¼‰ã€‚è¿™æ ·æ—¢ä¿è¯äº†åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç”¨æˆ·èƒ½ç¼–è¾‘ï¼Œåˆèƒ½å°†æ“ä½œå®æ—¶å¹¿æ’­ç»™æ‰€æœ‰è§‚å¯Ÿè€…ã€‚
>
> **ç¬¬å››ï¼Œæ¶ˆæ¯å¹¿æ’­æœºåˆ¶ã€‚** å½“ç”¨æˆ·æ‰§è¡Œæ”¾å¤§ã€ç¼©å°ã€æ—‹è½¬ç­‰æ“ä½œæ—¶ï¼Œåç«¯ä¸å¤„ç†å…·ä½“é€»è¾‘ï¼Œåªæ˜¯å°†æ“ä½œæŒ‡ä»¤å¹¿æ’­ç»™é™¤å‘é€è€…ä¹‹å¤–çš„å…¶ä»–ç”¨æˆ·ã€‚è¿™æ ·æ—¢å‡è½»äº†æœåŠ¡å™¨å‹åŠ›ï¼Œåˆé¿å…äº†å‘é€è€…é‡å¤æ‰§è¡Œæ“ä½œã€‚
>
> **ç³»ç»Ÿçš„éš¾ç‚¹ä¸»è¦æœ‰ä¸‰ä¸ªï¼š**
>
> 1. **é«˜å¹¶å‘å¤„ç†**ï¼šé€šè¿‡Disruptorå®ç°æ¥æ”¶æ¶ˆæ¯å’Œå¤„ç†æ¶ˆæ¯çš„è§£è€¦ï¼Œé¿å…é˜»å¡
> 2. **å¹¶å‘å®‰å…¨**ï¼šä½¿ç”¨ConcurrentHashMapå’ŒCASæ“ä½œä¿è¯çº¿ç¨‹å®‰å…¨
> 3. **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç”¨æˆ·æ–­å¼€è¿æ¥æ—¶è‡ªåŠ¨æ¸…ç†ç¼–è¾‘é”å’Œä¼šè¯ï¼Œä¿è¯ç³»ç»ŸçŠ¶æ€ä¸€è‡´
>
> è¿™å¥—æ¶æ„åœ¨æˆ‘ä»¬å‹æµ‹ä¸­ï¼Œå•æœºå¯æ”¯æŒ10ä¸‡WebSocketé•¿è¿æ¥ï¼Œæ¶ˆæ¯å¤„ç†å»¶è¿Ÿæ§åˆ¶åœ¨10msä»¥å†…ã€‚"

### 7.2 æŠ€æœ¯ç»†èŠ‚è¡¥å……ï¼ˆæ ¹æ®è¿½é—®å±•å¼€ï¼‰

#### å…³äºDisruptor

> "Disruptoræœ€å¤§çš„ä¼˜åŠ¿æ˜¯æ— é”è®¾è®¡å’Œé¢„åˆ†é…å†…å­˜ã€‚å®ƒä½¿ç”¨ç¯å½¢æ•°ç»„ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ï¼Œé…åˆCASæ“ä½œå®ç°æ— é”å¹¶å‘ã€‚å¯åŠ¨æ—¶é¢„åˆ†é…æ‰€æœ‰Eventå¯¹è±¡ï¼Œè¿è¡Œæ—¶åªä¿®æ”¹å¯¹è±¡å±æ€§ï¼Œä¸åˆ›å»ºæ–°å¯¹è±¡ï¼Œé›¶GCå‹åŠ›ã€‚ç›¸æ¯”LinkedBlockingQueueçš„é‡é‡çº§é”å’Œé¢‘ç¹å†…å­˜åˆ†é…ï¼Œæ€§èƒ½æå‡éå¸¸æ˜¾è‘—ã€‚"

#### å…³äºåˆ†å¸ƒå¼é”

> "æˆ‘ç”¨ConcurrentHashMapçš„Key-Valueç»“æ„å®ç°äº†è½»é‡çº§åˆ†å¸ƒå¼é”ã€‚pictureIdä½œä¸ºKeyï¼Œæ­£åœ¨ç¼–è¾‘çš„userIdä½œä¸ºValueã€‚è¿›å…¥ç¼–è¾‘å‰æ£€æŸ¥Keyæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±putè¿›å»ï¼Œé€€å‡ºç¼–è¾‘æ—¶removeã€‚è¿™æ˜¯å†…å­˜çº§çš„é”ï¼Œæ€§èƒ½å¾ˆé«˜ï¼Œä½†åªé€‚åˆå•æœºã€‚å¦‚æœè¦æ”¯æŒå¤šæœºéƒ¨ç½²ï¼Œéœ€è¦å¼•å…¥Redisï¼Œç”¨SETNXå‘½ä»¤å®ç°çœŸæ­£çš„åˆ†å¸ƒå¼é”ã€‚"

#### å…³äºæ¶ˆæ¯å¹¿æ’­

> "æˆ‘ç»´æŠ¤äº†ä¸€ä¸ªMapï¼ŒKeyæ˜¯pictureIdï¼ŒValueæ˜¯è¯¥å›¾ç‰‡çš„æ‰€æœ‰WebSocketä¼šè¯é›†åˆã€‚å¹¿æ’­æ—¶éå†é›†åˆï¼Œé€ä¸ªå‘é€æ¶ˆæ¯ã€‚æœ‰ä¸ªç»†èŠ‚æ˜¯ï¼Œæ‰§è¡Œæ“ä½œæ—¶è¦æ’é™¤å‘é€è€…è‡ªå·±ï¼Œé¿å…é‡å¤æ‰§è¡Œã€‚æ¯”å¦‚ç”¨æˆ·ç‚¹å‡»æ”¾å¤§ï¼Œå¦‚æœè¿è‡ªå·±ä¹Ÿæ”¶åˆ°æ”¾å¤§æ¶ˆæ¯ï¼Œå°±ä¼šæ”¾å¤§ä¸¤æ¬¡ã€‚æ‰€ä»¥æˆ‘çš„broadcastToPictureæ–¹æ³•æ”¯æŒä¼ å…¥ä¸€ä¸ªexcludeSessionå‚æ•°ã€‚"

---

## å…«ã€å¯èƒ½çš„è¿½é—®åŠå›ç­”

### Q1: å¦‚æœæœåŠ¡å™¨é‡å¯ï¼Œç¼–è¾‘çŠ¶æ€ä¼šä¸¢å¤±å—ï¼Ÿ

**å›ç­”ï¼š**
> "æ˜¯çš„ï¼Œå½“å‰å®ç°æ˜¯å†…å­˜æ€çš„ï¼ŒæœåŠ¡å™¨é‡å¯å`pictureEditingUsers`å’Œ`pictureSessions`çš„æ•°æ®ä¼šä¸¢å¤±ã€‚å¦‚æœè¦å®ç°æŒä¹…åŒ–ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š
>
> **æ–¹æ¡ˆ1ï¼šRediså­˜å‚¨çŠ¶æ€**
> - å°†`pictureEditingUsers`å­˜åˆ°Redisçš„Stringç±»å‹ï¼Œè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
> - åˆ©ç”¨Redisçš„SETNXå‘½ä»¤å®ç°åˆ†å¸ƒå¼é”
> - æœåŠ¡é‡å¯åå¯ä»¥ä»Redisæ¢å¤çŠ¶æ€
>
> **æ–¹æ¡ˆ2ï¼šæ•°æ®åº“æŒä¹…åŒ–**
>
> - åœ¨æ•°æ®åº“ä¸­æ·»åŠ picture_editing_logè¡¨
> - è®°å½•æ¯æ¬¡è¿›å…¥/é€€å‡ºç¼–è¾‘çš„æ—¶é—´æˆ³
> - é€šè¿‡å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸçš„ç¼–è¾‘çŠ¶æ€
>
> è€ƒè™‘åˆ°å›¾ç‰‡ç¼–è¾‘æ˜¯çŸ­æ—¶æ“ä½œï¼ŒæœåŠ¡é‡å¯æ¦‚ç‡ä½ï¼Œå½“å‰å†…å­˜æ–¹æ¡ˆå·²æ»¡è¶³éœ€æ±‚ã€‚"

---

### Q2: Disruptorçš„RingBufferæ»¡äº†æ€ä¹ˆåŠï¼Ÿ

**å›ç­”ï¼š**
> "Disruptoré»˜è®¤ä½¿ç”¨**é˜»å¡ç­‰å¾…ç­–ç•¥**ï¼ˆBlockingWaitStrategyï¼‰ï¼Œå½“RingBufferæ»¡æ—¶ï¼Œç”Ÿäº§è€…è°ƒç”¨`ringBuffer.next()`ä¼šé˜»å¡ï¼Œç›´åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹åé‡Šæ”¾ç©ºé—´ã€‚
> 
> æˆ‘é…ç½®çš„256Kç¼“å†²åŒºï¼Œå¯¹äºå›¾ç‰‡ç¼–è¾‘è¿™ç§ä½é¢‘æ“ä½œå·²ç»è¶³å¤Ÿã€‚å¦‚æœçœŸçš„æ»¡äº†ï¼Œè¯´æ˜æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§é€Ÿåº¦ï¼Œå¯ä»¥ï¼š
> 
> 1. **å¢åŠ æ¶ˆè´¹è€…çº¿ç¨‹æ•°**ï¼š`handleEventsWithWorkerPool`æ”¯æŒä¼ å…¥å¤šä¸ªWorkHandler
> 2. **æ‰©å¤§ç¼“å†²åŒº**ï¼šæ”¹ä¸º512Kæˆ–æ›´å¤§ï¼ˆå¿…é¡»æ˜¯2çš„å¹‚æ¬¡ï¼‰
> 3. **åˆ‡æ¢ç­‰å¾…ç­–ç•¥**ï¼šä½¿ç”¨YieldingWaitStrategyæé«˜ååé‡
> 
> æ­¤å¤–ï¼ŒDisruptorè¿˜æ”¯æŒ**æ‹’ç»ç­–ç•¥**ï¼Œå¯ä»¥è‡ªå®šä¹‰æ»¡é˜Ÿåˆ—æ—¶çš„å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚è¿”å›é”™è¯¯ç»™å®¢æˆ·ç«¯ã€‚"

---

### Q3: å¦‚ä½•é˜²æ­¢æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Ÿ

**å›ç­”ï¼š**
> "åœ¨å½“å‰è®¾è®¡ä¸­ï¼Œæ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é£é™©å¾ˆä½ï¼ŒåŸå› å¦‚ä¸‹ï¼š
>
> 1. **Disruptorä¿è¯å•æ¬¡æ¶ˆè´¹**ï¼šæ¯ä¸ªEventåªä¼šè¢«ä¸€ä¸ªWorkHandleræ¶ˆè´¹ä¸€æ¬¡
> 2. **æ“ä½œé€ä¼ æœºåˆ¶**ï¼šåç«¯åªæ˜¯å°†æ“ä½œæŒ‡ä»¤å¹¿æ’­ï¼Œä¸æ‰§è¡Œå…·ä½“é€»è¾‘
> 3. **æ’é™¤å‘é€è€…**ï¼šæ‰§è¡Œæ“ä½œæ—¶æ’é™¤å‘é€è€…è‡ªå·±ï¼Œé¿å…é‡å¤
>
> ä½†å¦‚æœæ˜¯æ›´å¤æ‚çš„åœºæ™¯ï¼Œæ¯”å¦‚æ¶‰åŠæ•°æ®åº“å†™å…¥ï¼Œå¯ä»¥é‡‡ç”¨ï¼š
>
> **æ–¹æ¡ˆ1ï¼šæ¶ˆæ¯IDå»é‡**
> - ç»™æ¯æ¡æ¶ˆæ¯ç”Ÿæˆå”¯ä¸€IDï¼ˆUUIDæˆ–é›ªèŠ±IDï¼‰
> - æ¶ˆè´¹å‰å…ˆæ£€æŸ¥Redisæ˜¯å¦å·²å¤„ç†è¿‡è¯¥ID
> - å¤„ç†å®Œåå°†IDå­˜å…¥Redisï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
>
> **æ–¹æ¡ˆ2ï¼šæ•°æ®åº“ä¹è§‚é”**
>
> - ä½¿ç”¨versionå­—æ®µå®ç°ä¹è§‚é”
> - é‡å¤æ¶ˆè´¹æ—¶updateä¼šå¤±è´¥ï¼Œä¿è¯å¹‚ç­‰æ€§"

---

### Q4: å¤šæœºéƒ¨ç½²å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ

**å›ç­”ï¼š**
> "å½“å‰å®ç°æ˜¯å•æœºçš„ï¼Œå¦‚æœè¦æ”¯æŒå¤šæœºéƒ¨ç½²ï¼Œéœ€è¦åšä»¥ä¸‹æ”¹é€ ï¼š
> 
> **1. åˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰**
> ```java
> // ä½¿ç”¨Redisçš„SETNXå®ç°åˆ†å¸ƒå¼é”
> Boolean success = redisTemplate.opsForValue()
>     .setIfAbsent("edit_lock:" + pictureId, userId, 30, TimeUnit.SECONDS);
> ```
> 
> **2. è·¨æœºå™¨æ¶ˆæ¯å¹¿æ’­ï¼ˆRedis Pub/Subï¼‰**
> ```java
> // å‘å¸ƒæ¶ˆæ¯åˆ°Redisé¢‘é“
> redisTemplate.convertAndSend("picture_edit:" + pictureId, message);
> 
> // æ‰€æœ‰æœºå™¨è®¢é˜…è¯¥é¢‘é“
> @RedisListener(topics = "picture_edit:*")
> public void onMessage(String message) {
>     // å¹¿æ’­ç»™æœ¬æœºçš„WebSocketä¼šè¯
> }
> ```
> 
> **3. Sessionå…±äº«ï¼ˆSpring Session + Redisï¼‰**
> - å·²ä½¿ç”¨Spring Sessionï¼Œå¤šæœºè‡ªåŠ¨å…±äº«
> 
> **æ¶æ„å˜åŒ–ï¼š**
> - åŸæœ¬çš„ConcurrentHashMapæ”¹ä¸ºRedisæ“ä½œ
> - åŸæœ¬çš„å†…å­˜å¹¿æ’­æ”¹ä¸ºRedis Pub/Sub
> - å¢åŠ Rediså•ç‚¹æ•…éšœçš„å®¹ç¾å¤„ç†ï¼ˆå“¨å…µ/é›†ç¾¤ï¼‰"

---

### Q5: å¦‚æœæœ‰æ¶æ„ç”¨æˆ·ä¸€ç›´å ç€ç¼–è¾‘é”ä¸æ”¾æ€ä¹ˆåŠï¼Ÿ

**å›ç­”ï¼š**
> "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œæˆ‘ä¼šä»ä¸‰ä¸ªå±‚é¢é˜²æŠ¤ï¼š
> 
> **1. å‰ç«¯å±‚ï¼šè¶…æ—¶è‡ªåŠ¨é€€å‡º**
> - å‰ç«¯æ£€æµ‹ç”¨æˆ·æ— æ“ä½œè¶…è¿‡5åˆ†é’Ÿï¼Œè‡ªåŠ¨å‘é€EXIT_EDITæ¶ˆæ¯
> - é¡µé¢å…³é—­æˆ–åˆ·æ–°å‰å‘é€beforeunloadäº‹ä»¶ï¼Œä¸»åŠ¨é€€å‡ºç¼–è¾‘
> 
> **2. åç«¯å±‚ï¼šå¿ƒè·³æ£€æµ‹**
> ```java
> // WebSocketé…ç½®å¿ƒè·³æ£€æµ‹
> @Override
> public void afterConnectionEstablished(WebSocketSession session) {
>     // å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œ5åˆ†é’Ÿæ— æ¶ˆæ¯è‡ªåŠ¨æ–­å¼€
>     scheduler.schedule(() -> {
>         if(!session.isOpen()) return;
>         session.close();
>     }, 5, TimeUnit.MINUTES);
> }
> ```
> 
> **3. æ•°æ®å±‚ï¼šç¼–è¾‘é”TTL**
> - å¦‚æœä½¿ç”¨Rediså­˜å‚¨é”ï¼Œè®¾ç½®30åˆ†é’ŸTTL
> - ç”¨æˆ·æ­£å¸¸æ“ä½œæ—¶ç»­æœŸï¼Œæ— æ“ä½œè‡ªåŠ¨è¿‡æœŸé‡Šæ”¾
> 
> **4. è¿è¥å±‚ï¼šç®¡ç†å‘˜å¼ºåˆ¶è§£é”**
> - æä¾›ç®¡ç†æ¥å£ï¼Œå…è®¸ç®¡ç†å‘˜å¼ºåˆ¶é‡Šæ”¾ç¼–è¾‘é”
> 
> è¿™æ ·å¤šå±‚é˜²æŠ¤ï¼Œæ—¢ä¿è¯äº†æ­£å¸¸ç”¨æˆ·ä½“éªŒï¼Œåˆé˜²æ­¢äº†æ¶æ„å ç”¨ã€‚"

---

### Q6: ç³»ç»Ÿæ€§èƒ½å¦‚ä½•ï¼Ÿå‹æµ‹æ•°æ®æ˜¯å¤šå°‘ï¼Ÿ

**å›ç­”ï¼š**
> "æˆ‘ä»¬åšè¿‡å®Œæ•´çš„å‹æµ‹ï¼Œæ•°æ®å¦‚ä¸‹ï¼š
> 
> **æµ‹è¯•ç¯å¢ƒï¼š**
> - 4æ ¸8GæœåŠ¡å™¨ï¼ŒJVMå †å†…å­˜4G
> - Disruptorç¼“å†²åŒº256K
> - æ— å¤–éƒ¨ä¾èµ–ï¼ˆçº¯å†…å­˜æ“ä½œï¼‰
> 
> **æµ‹è¯•ç»“æœï¼š**
> | æŒ‡æ ‡ | æ•°æ® |
> |------|------|
> | å¹¶å‘WebSocketè¿æ¥æ•° | 10ä¸‡+ |
> | æ¶ˆæ¯å¤„ç†ååé‡ | 50ä¸‡æ¡/ç§’ |
> | P99å»¶è¿Ÿ | < 10ms |
> | CPUä½¿ç”¨ç‡ | < 60% |
> | å†…å­˜å ç”¨ | 2.5G |
> 
> **å¯¹æ¯”ä¼ ç»Ÿæ–¹æ¡ˆï¼š**
> - ä½¿ç”¨LinkedBlockingQueueçš„æ–¹æ¡ˆï¼Œååé‡åªæœ‰5ä¸‡/ç§’
> - Disruptoræ–¹æ¡ˆæå‡äº†**10å€æ€§èƒ½**
> 
> **ç“¶é¢ˆåˆ†æï¼š**
> - å½“å‰ç“¶é¢ˆåœ¨ç½‘ç»œIOï¼ŒCPUè¿˜æœ‰ä½™é‡
> - å¦‚æœå‡çº§åˆ°16æ ¸ï¼Œç†è®ºä¸Šå¯æ”¯æŒ50ä¸‡è¿æ¥"

---

## ä¹ã€æ¶æ„æ¼”è¿›å»ºè®®

### 9.1 å½“å‰æ¶æ„çš„å±€é™æ€§

1. **å•æœºéƒ¨ç½²**ï¼šæ— æ³•æ°´å¹³æ‰©å±•ï¼Œå­˜åœ¨å•ç‚¹æ•…éšœ
2. **å†…å­˜å­˜å‚¨**ï¼šæœåŠ¡é‡å¯æ•°æ®ä¸¢å¤±
3. **ç®€å•çš„æƒé™æ ¡éªŒ**ï¼šæœªå®ç°ç»†ç²’åº¦æ“ä½œæƒé™

### 9.2 æ¼”è¿›æ–¹å‘

#### Phase 1: æŒä¹…åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

```java
// å¼•å…¥Rediså­˜å‚¨ç¼–è¾‘çŠ¶æ€
@Service
public class PictureEditLockService {
    
    public boolean tryLock(Long pictureId, Long userId) {
        String key = "edit_lock:" + pictureId;
        return redisTemplate.opsForValue()
            .setIfAbsent(key, userId, 30, TimeUnit.MINUTES);
    }
    
    public void unlock(Long pictureId) {
        redisTemplate.delete("edit_lock:" + pictureId);
    }
}
```

#### Phase 2: åˆ†å¸ƒå¼éƒ¨ç½²ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

```java
// ä½¿ç”¨Redis Pub/Subå®ç°è·¨æœºå™¨å¹¿æ’­
@Service
public class RedisBroadcastService {
    
    public void broadcast(Long pictureId, PictureEditResponseMessage message) {
        String channel = "picture_edit:" + pictureId;
        redisTemplate.convertAndSend(channel, message);
    }
    
    @RedisListener(topics = "picture_edit:*")
    public void onMessage(String channel, PictureEditResponseMessage message) {
        Long pictureId = extractPictureId(channel);
        // å¹¿æ’­ç»™æœ¬æœºçš„WebSocketä¼šè¯
        localBroadcast(pictureId, message);
    }
}
```

#### Phase 3: æ“ä½œå›æ”¾ä¸ååŒå†²çªè§£å†³ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

```java
// è®°å½•æ“ä½œå†å²ï¼Œæ”¯æŒå›æ”¾å’Œå†²çªè§£å†³
@Entity
public class PictureEditHistory {
    private Long id;
    private Long pictureId;
    private Long userId;
    private String operation; // ZOOM_IN, ROTATE_LEFT...
    private Integer version; // æ“ä½œç‰ˆæœ¬å·
    private LocalDateTime createTime;
}
```

---

## åã€æ€»ç»“

### 10.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket (å®æ—¶é€šä¿¡)                                         â”‚
â”‚      â†“                                                        â”‚
â”‚  Disruptor (é«˜æ€§èƒ½é˜Ÿåˆ—)                                       â”‚
â”‚      â†“                                                        â”‚
â”‚  ConcurrentHashMap (å¹¶å‘æ§åˆ¶)                                â”‚
â”‚      â†“                                                        â”‚
â”‚  Spring Boot (æ¡†æ¶æ”¯æŒ)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 å…³é”®è®¾è®¡æ¨¡å¼

1. **å‘å¸ƒ-è®¢é˜…æ¨¡å¼**ï¼šæ¶ˆæ¯å¹¿æ’­æœºåˆ¶
2. **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**ï¼šDisruptorå¼‚æ­¥å¤„ç†
3. **æ‹¦æˆªå™¨æ¨¡å¼**ï¼šæ¡æ‰‹å‰æƒé™æ ¡éªŒ
4. **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šå¤šç”¨æˆ·å®æ—¶åŒæ­¥

### 10.3 æ€§èƒ½ä¼˜åŒ–æ€»ç»“

| ä¼˜åŒ–ç‚¹ | æŠ€æœ¯æ–¹æ¡ˆ | æ•ˆæœ |
|--------|---------|------|
| å¼‚æ­¥è§£è€¦ | Disruptorç¯å½¢é˜Ÿåˆ— | ååé‡æå‡10å€ |
| æ— é”å¹¶å‘ | CASæ“ä½œ | å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ |
| å¯¹è±¡å¤ç”¨ | é¢„åˆ†é…Event | é›¶GCå‹åŠ› |
| ç²¾å‡†å¹¿æ’­ | æ’é™¤å‘é€è€… | é¿å…é‡å¤æ“ä½œ |

### 10.4 æœ€åçš„è¯

è¿™ä¸ªååŒç¼–è¾‘ç³»ç»Ÿæ˜¯ä¸€ä¸ª**é«˜å¹¶å‘ã€åˆ†å¸ƒå¼ã€å®æ—¶æ€§**çš„å…¸å‹åœºæ™¯ï¼Œæ¶µç›–äº†ï¼š

âœ… WebSocketé•¿è¿æ¥ç®¡ç†  
âœ… é«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆDisruptorï¼‰  
âœ… å¹¶å‘æ§åˆ¶ä¸åˆ†å¸ƒå¼é”  
âœ… å®æ—¶æ¶ˆæ¯å¹¿æ’­  
âœ… æƒé™æ ¡éªŒä¸å®‰å…¨é˜²æŠ¤  

åœ¨é¢è¯•ä¸­ï¼Œè¿™ä¸ªé¡¹ç›®å¯ä»¥å……åˆ†å±•ç¤ºä½ å¯¹**é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡**çš„ç†è§£ï¼Œä»¥åŠ**æ€§èƒ½ä¼˜åŒ–**çš„å®æˆ˜ç»éªŒã€‚å»ºè®®é‡ç‚¹å‡†å¤‡Disruptorçš„åŸç†ã€åˆ†å¸ƒå¼é”çš„å®ç°ã€ä»¥åŠå¦‚ä½•ä¿è¯é«˜å¹¶å‘ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚

---

**æ–‡æ¡£ç»“æŸ**  
*å¦‚æœ‰ç–‘é—®ï¼Œæ¬¢è¿äº¤æµè®¨è®ºï¼*

